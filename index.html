<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>√çndices Moveleiro ‚Äî Modern Dashboard v3.9</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
:root {
  --bg: #dfe1e1;
  --card: #ffffff;
  --shadow: 0 3px 10px rgba(0,0,0,0.08);
  --title-bg: #000000;
  --title-fg: #ffffff;
  --accent: #f5b95f;
}
* { box-sizing: border-box; }
body { background: var(--bg); color:#111; font-family: Inter, Arial, sans-serif; margin:24px; }
section { margin-bottom: 34px; }
.titlebar { background: var(--title-bg); color: var(--title-fg); padding: 10px 16px; border-radius: 6px 6px 0 0; font-weight: 600; }
.card { background: var(--card); box-shadow: var(--shadow); border-radius: 0 0 10px 10px; padding: 16px; }
.controls { display:flex; gap:10px; align-items:center; margin: 12px 0 8px 0; flex-wrap: wrap; }
.status { margin-left:auto; font-size:12px; color:#333; background:#fff; padding:6px 10px; border:1px solid #e5e5e5; border-radius:8px; }
input[type=date], button { padding: 8px 12px; border-radius:8px; border:1px solid #e5e5e5; }
button { background:#f7f7f7; cursor:pointer; }
#chartGeral { width:100%; height:600px; }
#chartCRC, #chartIron, #chartFreight, #chartFX { width:100%; height:460px; }
.small { color:#666; font-size:12px; }
.badge { background:#fff; border:1px solid #e5e5e5; padding:6px 10px; border-radius:8px; font-size:12px; }
@media (max-width: 720px) {
  body { margin: 12px; }
  #chartGeral { height: 520px; }
  #chartCRC, #chartIron, #chartFreight, #chartFX { height: 380px; }
}
</style>
</head>
<body>

<section id="geral">
  <div class="titlebar">√çndices Moveleiro</div>
  <div class="card">
    <div class="controls">
      <label>Data inicial: <input type="date" id="start"></label>
      <label>Data final: <input type="date" id="end"></label>
      <button id="apply">Aplicar filtro</button>
      <button id="refresh">Atualizar dados üîÑ</button>
      <button id="download">Baixar CSV</button>
      <span id="info" class="small badge"></span>
      <span id="lastUpdate" class="small badge"></span>
      <span id="status" class="status"></span>
    </div>
    <div id="chartGeral"></div>
  </div>
</section>

<section id="crc">
  <div class="titlebar">A√ßo CRC China (USD/TON)</div>
  <div class="card"><div id="chartCRC"></div></div>
</section>

<section id="iron">
  <div class="titlebar">Min√©rio de Ferro (USD/TON)</div>
  <div class="card"><div id="chartIron"></div></div>
</section>

<section id="freight">
  <div class="titlebar">Frete Mar√≠timo (USD/TEU)</div>
  <div class="card"><div id="chartFreight"></div></div>
</section>

<section id="fx">
  <div class="titlebar">Taxas de C√¢mbio (USD/BRL e USD/CNY)</div>
  <div class="card"><div id="chartFX"></div></div>
</section>

<script>
const CSV_URL = "data/indices_moveleiro.csv";
let RAW = null;
const PT_ABBR = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

function toNumber(v) {
  if (v === null || v === undefined || v === "") return null;
  if (typeof v === "number") return v;
  const s = String(v).trim().replace(/\s+/g,'');
  const normalized = s.replace(",", ".");
  const n = parseFloat(normalized);
  return Number.isFinite(n) ? n : null;
}
function normalizeRow(r) {
  return {
    date: r.date,
    crc: toNumber(r.CRC_China_USD_ton),
    iron: toNumber(r.Iron_Ore_USD_ton),
    freight: toNumber(r.Sea_Freight_USD_ton),
    usdbrl: toNumber(r.USD_BRL_buy),
    usdcny: toNumber(r.USD_CNY)
  };
}
function monthTicks(dates) {
  const seen = new Set(), tickvals = [], ticktext = [];
  for (let i=0;i<dates.length;i++) {
    const dt = new Date(dates[i]);
    const key = dt.getFullYear()+"-"+(dt.getMonth()+1);
    if (!seen.has(key)) { seen.add(key); tickvals.push(dates[i]); ticktext.push(PT_ABBR[dt.getMonth()]); }
  }
  return {tickvals, ticktext};
}
function filterData(s=null, e=null) {
  const S = s? new Date(s):null, E = e? new Date(e):null;
  const out={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};
  for (let i=0;i<RAW.date.length;i++){
    const d=new Date(RAW.date[i]);
    if ((S&&d<S)||(E&&d>E)) continue;
    out.date.push(RAW.date[i]);
    out.crc.push(RAW.crc[i]);
    out.iron.push(RAW.iron[i]);
    out.freight.push(RAW.freight[i]);
    out.usdbrl.push(RAW.usdbrl[i]);
    out.usdcny.push(RAW.usdcny[i]);
  }
  return out;
}
function loadCSV(){
  return new Promise((resolve,reject)=>{
    Papa.parse(`${CSV_URL}?v=${Date.now()}`,{
      download:true, header:true,
      complete:(res)=>{
        const rows=res.data.filter(r=>r&&r.date);
        const n=rows.map(normalizeRow);
        const out={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};
        n.forEach(r=>{
          out.date.push(r.date); out.crc.push(r.crc);
          out.iron.push(r.iron); out.freight.push(r.freight);
          out.usdbrl.push(r.usdbrl); out.usdcny.push(r.usdcny);
        });
        resolve(out);
      }, error:reject
    });
  });
}
function drawAll(s=null,e=null){
  const D=filterData(s,e);
  const info=document.getElementById('info');
  if(info) info.innerText=D.date.length?`Per√≠odo: ${D.date[0]} a ${D.date[D.date.length-1]} ‚Äî ${D.date.length} pontos`:'';
  const last=document.getElementById('lastUpdate');
  if(last&&D.date.length){
    const dt=new Date(D.date[D.date.length-1]);
    last.innerText=`√öltima atualiza√ß√£o: ${dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
  }
  const status=document.getElementById('status');
  if(status){
    const flags=[
      ['A√ßo CRC',D.crc],['Min√©rio de Ferro',D.iron],['Frete Mar√≠timo',D.freight],['USD/BRL',D.usdbrl],['USD/CNY',D.usdcny]
    ].map(([n,a])=>`${n}: ${a.some(v=>v)?'‚úÖ':'‚ö†Ô∏è sem dados'}`);
    status.innerText=flags.join(' | ');
  }
  const {tickvals,ticktext}=monthTicks(D.date);
  const lineCfg=(c)=>({mode:'lines+markers',line:{shape:'spline',smoothing:0.6,width:2.2,color:c},marker:{size:8,line:{width:1,color:'#fff'}}});
  // === Geral ===
  Plotly.newPlot('chartGeral',[
    {x:D.date,y:D.crc,name:'A√ßo CRC China (USD/TON)',...lineCfg('#007bff')},
    {x:D.date,y:D.iron,name:'Min√©rio de Ferro (USD/TON)',...lineCfg('#ff6f00')},
    {x:D.date,y:D.freight,name:'Frete Mar√≠timo (USD/TEU)',...lineCfg('#00bfa6')},
    {x:D.date,y:D.usdbrl?.map(v=>v?v*100:v),name:'USD/BRL √ó100',yaxis:'y2',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny?.map(v=>v?v*100:v),name:'USD/CNY √ó100',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    hovermode:'x unified',
    legend:{orientation:'h',y:1.12},
    xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},
    yaxis:{title:'USD/TON (CRC, Min√©rio, Frete)',gridcolor:'#e9ecef',zeroline:false},
    yaxis2:{title:'C√¢mbio √ó100',overlaying:'y',side:'right'},
    paper_bgcolor:'#fff',plot_bgcolor:'#fff'
  });
  const subLayout={hovermode:'x unified',xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},yaxis:{gridcolor:'#e9ecef',zeroline:false},paper_bgcolor:'#fff',plot_bgcolor:'#fff'};
  Plotly.newPlot('chartCRC',[{x:D.date,y:D.crc,name:'A√ßo CRC China (USD/TON)',...lineCfg('#007bff')}],{...subLayout,yaxis:{...subLayout.yaxis,title:'USD/TON'}});
  Plotly.newPlot('chartIron',[{x:D.date,y:D.iron,name:'Min√©rio de Ferro (USD/TON)',...lineCfg('#ff6f00')}],{...subLayout,yaxis:{...subLayout.yaxis,title:'USD/TON'}});
  Plotly.newPlot('chartFreight',[{x:D.date,y:D.freight,name:'Frete Mar√≠timo (USD/TEU)',...lineCfg('#00bfa6')}],{...subLayout,yaxis:{...subLayout.yaxis,title:'USD/TEU'}});
  // === FX FIXED ===
  const minBRL=Math.min(...D.usdbrl.filter(v=>v)), maxBRL=Math.max(...D.usdbrl.filter(v=>v));
  const minCNY=Math.min(...D.usdcny.filter(v=>v)), maxCNY=Math.max(...D.usdcny.filter(v=>v));
  Plotly.newPlot('chartFX',[
    {x:D.date,y:D.usdbrl,name:'USD/BRL',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    hovermode:'x unified',
    legend:{orientation:'h',y:1.12},
    xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},
    yaxis:{title:'USD/BRL',gridcolor:'#e9ecef',zeroline:false,side:'left',range:[minBRL*0.98,maxBRL*1.02]},
    yaxis2:{title:'USD/CNY',overlaying:'y',side:'right',range:[minCNY*0.98,maxCNY*1.02]},
    paper_bgcolor:'#fff',plot_bgcolor:'#fff'
  });
}
function wireUI(){
  document.getElementById('apply').addEventListener('click',()=>{
    drawAll(document.getElementById('start').value||null,document.getElementById('end').value||null);
  });
  document.getElementById('refresh').addEventListener('click',async()=>{
    setBusy("Atualizando dados‚Ä¶");
    try{RAW=await loadCSV();initDateInputs();clearBusy();drawAll();}catch(e){console.error(e);setError("‚ùå Falha ao atualizar dados");}
  });
  document.getElementById('download').addEventListener('click',()=>{
    const s=document.getElementById('start').value||null,e=document.getElementById('end').value||null;
    const D=filterData(s,e);let csv="date,CRC,Iron,Freight,USD/BRL,USD/CNY\n";
    for(let i=0;i<D.date.length;i++){csv+=`${D.date[i]},${D.crc[i]??""},${D.iron[i]??""},${D.freight[i]??""},${D.usdbrl[i]??""},${D.usdcny[i]??""}\n`;}
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);a.download='indices_moveleiro_filtrado.csv';a.click();
  });
}
function setBusy(m){document.getElementById('status').innerText=m;}
function clearBusy(){document.getElementById('status').innerText='';}
function setError(m){document.getElementById('status').innerText=m;}
function initDateInputs(){
  if(!RAW||!RAW.date.length)return;
  const s=document.getElementById('start'),e=document.getElementById('end');
  s.min=RAW.date[0];s.max=RAW.date.at(-1);e.min=RAW.date[0];e.max=RAW.date.at(-1);
  s.value=RAW.date[0];e.value=RAW.date.at(-1);
}
(async function boot(){
  try{
    setBusy("Carregando dados‚Ä¶");
    RAW=await loadCSV();
    initDateInputs();
    wireUI();
    clearBusy();
    drawAll();
  }catch(e){console.error(e);setError("‚ùå Falha ao carregar dados");}
})();
</script>
</body>
</html>
