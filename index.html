<!-- v4.9.2 | Último mês refined for current year only | Compact build | © Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Índices Moveleiro — Modern Dashboard v4.9.2</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
:root{--bg:#dfe1e1;--card:#fff;--shadow:0 3px 10px rgba(0,0,0,.08);--title-bg:#000;--title-fg:#fff;--accent:#f5b95f}
body{background:var(--bg);color:#111;font-family:Inter,Arial,sans-serif;margin:24px}
h1,h2{margin:0}
section{margin-bottom:34px}
.titlebar{background:var(--title-bg);color:var(--title-fg);padding:10px 16px;border-radius:6px 6px 0 0;font-weight:600;letter-spacing:.2px}
.card{background:var(--card);box-shadow:var(--shadow);border-radius:0 0 10px 10px;padding:16px}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0 8px 0}
.year-block{background:#f8f9fb;border-left:6px solid var(--accent);padding:10px 14px;border-radius:8px;box-shadow:var(--shadow)}
.year-title{font-weight:600;margin-bottom:6px;color:#222}
.fx-cap{font-weight:600;margin-bottom:6px;color:#222;text-align:center}
.fx-last,.last-month{margin-top:10px;color:#111;font-weight:600}
.small{color:#666;font-size:12px}
.range-buttons{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.range-buttons button{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer;font-size:13px}
.range-buttons button.active{background:var(--accent);color:#000;font-weight:600}
@media(max-width:768px){
body{margin:12px}
.titlebar{font-size:15px}
.summary-grid{grid-template-columns:1fr}
.range-buttons{justify-content:center}
}
</style>
</head>
<body>

<section id="geral">
  <div class="titlebar">Visão Geral</div>
  <div class="card">
    <div class="range-buttons" id="ranges-geral">
      <button data-range="3M">3M</button>
      <button data-range="6M">6M</button>
      <button data-range="1A">1A</button>
      <button data-range="5A">5A</button>
      <button data-range="TUDO" class="active">Tudo</button>
    </div>
    <div id="chartGeral" style="width:100%;height:600px"></div>
  </div>
</section>

<section id="crc">
  <div class="titlebar">Aço CRC China (USD/TON)</div>
  <div class="card">
    <div class="range-buttons" id="ranges-crc">
      <button data-range="3M">3M</button><button data-range="6M">6M</button>
      <button data-range="1A">1A</button><button data-range="5A">5A</button>
      <button data-range="TUDO" class="active">Tudo</button>
    </div>
    <div id="chartCRC" style="width:100%;height:460px"></div>
    <div id="summary-crc" class="summary-grid"></div>
  </div>
</section>

<section id="iron">
  <div class="titlebar">Minério de Ferro (USD/TON)</div>
  <div class="card">
    <div class="range-buttons" id="ranges-iron">
      <button data-range="3M">3M</button><button data-range="6M">6M</button>
      <button data-range="1A">1A</button><button data-range="5A">5A</button>
      <button data-range="TUDO" class="active">Tudo</button>
    </div>
    <div id="chartIron" style="width:100%;height:460px"></div>
    <div id="summary-iron" class="summary-grid"></div>
  </div>
</section>

<section id="freight">
  <div class="titlebar">Frete Marítimo (USD/TEU)</div>
  <div class="card">
    <div class="range-buttons" id="ranges-freight">
      <button data-range="3M">3M</button><button data-range="6M">6M</button>
      <button data-range="1A">1A</button><button data-range="5A">5A</button>
      <button data-range="TUDO" class="active">Tudo</button>
    </div>
    <div id="chartFreight" style="width:100%;height:460px"></div>
    <div id="summary-freight" class="summary-grid"></div>
  </div>
</section>

<section id="fx">
  <div class="titlebar">Taxas de Câmbio (USD/BRL e USD/CNY)</div>
  <div class="card">
    <div class="range-buttons" id="ranges-fx">
      <button data-range="3M">3M</button><button data-range="6M">6M</button>
      <button data-range="1A">1A</button><button data-range="5A">5A</button>
      <button data-range="TUDO" class="active">Tudo</button>
    </div>
    <div id="chartFX" style="width:100%;height:460px"></div>
    <div id="summary-fx" class="summary-grid" style="grid-template-columns:repeat(4,1fr)"></div>
  </div>
</section>
<script>
/* ====== CONFIG ====== */
const CSV_URL = 'data/indices_moveleiro.csv';
const PT_ABBR = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const RANGES = {geral:'TUDO', crc:'TUDO', iron:'TUDO', freight:'TUDO', fx:'TUDO'};
const RANGE_TO_MONTHS = { '3M':3, '6M':6, '1A':12, '5A':60, 'TUDO':null };
const isMobile = () => window.innerWidth < 768;

/* ====== CSV LOADER (lightweight) ====== */
async function loadCSV(url){
  const text = await fetch(url + '?v=' + Date.now()).then(r=>r.text());
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const headers = lines[0].split(',').map(h=>h.trim());
  const out = [];
  for(let i=1;i<lines.length;i++){
    if(!lines[i].trim()) continue;
    const cols = lines[i].split(',');
    const row = {};
    headers.forEach((h,idx)=> row[h] = cols[idx]!==undefined? cols[idx].trim(): '');
    out.push(row);
  }
  return out;
}
const toNumber = v => (v==null||v==='')? null : (isNaN(parseFloat(String(v).replace(',','.')))? null : parseFloat(String(v).replace(',','.')));

/* ====== DATA NORMALIZATION ====== */
function normalize(rows){
  const date=[], crc=[], iron=[], freight_raw=[], usdbrl=[], usdcny=[];
  rows.forEach(r=>{
    date.push(r.date);
    crc.push(toNumber(r.CRC_China_USD_ton));
    iron.push(toNumber(r.Iron_Ore_USD_ton));
    freight_raw.push(toNumber(r.Sea_Freight_USD_ton));
    usdbrl.push(toNumber(r.USD_BRL_buy));
    usdcny.push(toNumber(r.USD_CNY));
  });
  return {date, crc, iron, freight_raw, usdbrl, usdcny};
}

/* ====== HELPERS ====== */
function monthlyReduceFreight(dates, values){
  const map=new Map(); // key YYYY-M → latest {date,value}
  for(let i=0;i<dates.length;i++){
    const d=new Date(dates[i]); const key=`${d.getFullYear()}-${d.getMonth()+1}`;
    map.set(key,{date:dates[i],value:values[i]});
  }
  const arr=[...map.values()].sort((a,b)=>new Date(a.date)-new Date(b.date));
  return {dates:arr.map(x=>x.date), values:arr.map(x=>x.value)};
}
function monthEndSeries(dates, values){
  const map=new Map();
  for(let i=0;i<dates.length;i++){
    const d=new Date(dates[i]); const key=`${d.getFullYear()}-${d.getMonth()+1}`;
    map.set(key,{date:dates[i],value:values[i]});
  }
  const arr=[...map.values()].sort((a,b)=>new Date(a.date)-new Date(b.date));
  return {dates:arr.map(x=>x.date), values:arr.map(x=>x.value)};
}
const pct = v => v==null? '—' : ((v>=0?'+':'') + v.toFixed(1).replace('.',',') + ' %');
function formatMoMLabel(d1,d2){
  return `${PT_ABBR[d1.getMonth()]} – ${PT_ABBR[d2.getMonth()]} ${d2.getFullYear()}`;
}
function evenMonthTicksWithYear(dates){
  const seen=new Set(), tickvals=[], ticktext=[];
  for(const iso of dates){
    const dt=new Date(iso), m=dt.getMonth()+1, y=String(dt.getFullYear()).slice(-2);
    const key=`${dt.getFullYear()}-${m}`;
    if(m%2===0 && !seen.has(key)){ seen.add(key); tickvals.push(iso); ticktext.push(`${PT_ABBR[m-1]} ${y}`); }
  }
  return {tickvals, ticktext};
}
function sliceByMonths(dates, arrays, months){
  if(months==null) return {dates:[...dates], ...Object.fromEntries(Object.keys(arrays).map(k=>[k,[...arrays[k]]]))};
  const last=new Date(dates[dates.length-1]); const from=new Date(last); from.setMonth(from.getMonth()-months);
  const start=dates.findIndex(d=>new Date(d)>=from); const s=start<0?0:start;
  const outDates=dates.slice(s); const out={};
  for(const k in arrays) out[k]=arrays[k].slice(s);
  return {dates:outDates, ...out};
}
function quarterChanges(dates, vals){
  const ymap={};
  for(let i=0;i<dates.length;i++){
    const d=new Date(dates[i]), y=d.getFullYear(), q=Math.floor(d.getMonth()/3)+1;
    (ymap[y]??=( {1:[],2:[],3:[],4:[]} ))[q].push(vals[i]);
  }
  const out={};
  for(const y in ymap){
    out[y]={};
    for(let q=1;q<=4;q++){
      const a=ymap[y][q]; if(!a.length){ out[y][q]=null; continue; }
      const f=a[0], l=a[a.length-1]; out[y][q]=(f!=null&&l!=null)? ((l-f)/f*100):null;
    }
  }
  return out;
}
function lastMonthLine(dates, vals, yearFilter=null){
  const red=monthEndSeries(dates, vals);
  const pairs = red.dates.map((d,i)=>({d,v:red.values[i]})).filter(o=>o.v!=null && (!yearFilter || new Date(o.d).getFullYear()===yearFilter));
  if(pairs.length<2) return '';
  const d1=new Date(pairs[pairs.length-2].d), d2=new Date(pairs[pairs.length-1].d);
  const v1=pairs[pairs.length-2].v, v2=pairs[pairs.length-1].v;
  return `Último mês (${formatMoMLabel(d1,d2)}): ${pct(((v2-v1)/v1*100))}`;
}
const lastMonthLineFX = lastMonthLine;
const getLatestYear = dates => Math.max(...dates.map(d=>new Date(d).getFullYear()));

/* ====== CHART COMMON ====== */
function lineCfg(color){
  return {mode:'lines+markers', line:{shape:'spline',smoothing:.6,width:isMobile()?2:3}, marker:{size:isMobile()?5:7,line:{width:1,color:'#fff'}}, hovertemplate:'%{y:.2f}<extra>%{fullData.name}</extra>', line:{...{shape:'spline',smoothing:.6,width:isMobile()?2:3}, color}};
}
function axisLayout(yTitle, xt){
  const tf=isMobile()?10:12;
  return {
    hovermode:'x unified',
    legend:{orientation:'h', y:-0.25, font:{size:isMobile()?11:12}},
    xaxis:{showgrid:false, tickmode:'array', ...xt, tickfont:{size:tf}, automargin:true},
    yaxis:{gridcolor:'#e9ecef', zeroline:false, title:yTitle, tickfont:{size:tf}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    margin:{t:40,r:30,b:80,l:60}
  };
}

/* ====== RENDER SUMMARIES ====== */
function renderSummary(containerId, dates, vals){
  const el=document.getElementById(containerId); if(!el) return;
  const qData = quarterChanges(dates, vals);
  const years = Object.keys(qData).map(Number).sort((a,b)=>b-a);
  const y1=years[0], y2=years[1]??years[0], latest=getLatestYear(dates);
  const fmt=v=>v==null?'n/d':pct(v);
  const block = y => {
    const list=[1,2,3,4].map(q=>`<li>${q}º trimestre: ${fmt((qData[y]||{})[q])}</li>`).join('');
    const last = (y===latest)? `<div class="last-month">${lastMonthLine(dates, vals, y)}</div>` : '';
    return `<div class="year-block"><div class="year-title">${y}</div><ul>${list}</ul>${last}</div>`;
  };
  el.innerHTML = `<div class="summary-grid">${block(y1)}${block(y2)}</div>`;
}
function renderSummaryFreight(containerId, freightDates, freightVals){
  renderSummary(containerId, freightDates, freightVals);
}
function renderSummaryFX(containerId, dates, brl, cny){
  const el=document.getElementById(containerId); if(!el) return;
  const qb=quarterChanges(dates, brl), qc=quarterChanges(dates, cny);
  const years=[...new Set(dates.map(d=>new Date(d).getFullYear()))].sort((a,b)=>b-a);
  const yL=years[0], yP=years[1]??years[0];
  const fmt=v=>v==null?'n/d':pct(v);
  const col = (y, label, series, qmap) => {
    const list=[1,2,3,4].map(q=>`<li>${q}º trimestre: ${fmt((qmap[y]||{})[q])}</li>`).join('');
    const last=(y===yL)? `<div class="fx-last">${lastMonthLineFX(dates, series, y)}</div>` : '';
    return `<div class="year-block"><div class="fx-cap">${y} ${label}</div><ul>${list}</ul>${last}</div>`;
  };
  el.innerHTML = col(yL,'USD/BRL',brl,qb)+col(yL,'USD/CNY',cny,qc)+col(yP,'USD/BRL',brl,qb)+col(yP,'USD/CNY',cny,qc);
}

/* ====== DRAWERS ====== */
let RAW=null; // {date, crc, iron, freight_raw, usdbrl, usdcny, freight_dates, freight}
function drawGeral(){
  const m=RANGE_TO_MONTHS[RANGES.geral];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc, iron:RAW.iron, usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, m);
  const sf = sliceByMonths(RAW.freight_dates, {freight:RAW.freight}, m);
  const xt=evenMonthTicksWithYear(sliced.dates);
  Plotly.newPlot('chartGeral',[
    {x:sliced.dates,y:sliced.crc,name:'Aço CRC China (USD/TON)',...lineCfg('#007bff')},
    {x:sliced.dates,y:sliced.iron,name:'Minério de Ferro (USD/TON)',...lineCfg('#ff6f00')},
    {x:sf.dates,y:sf.freight,name:'Frete Marítimo (USD/TEU)',...lineCfg('#00bfa6')},
    {x:sliced.dates,y:sliced.usdbrl,name:'USD/BRL',yaxis:'y2',...lineCfg('#7e57c2')},
    {x:sliced.dates,y:sliced.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/TON (CRC, Minério, Frete)', xt),
    yaxis2:{title:'Câmbio (USD/BRL, USD/CNY)', overlaying:'y', side:'right', tickfont:{size:isMobile()?10:12}}
  },{responsive:true});
}
function drawCRC(){
  const m=RANGE_TO_MONTHS[RANGES.crc];
  const s=sliceByMonths(RAW.date,{y:RAW.crc},m); const xt=evenMonthTicksWithYear(s.dates);
  Plotly.newPlot('chartCRC',[{x:s.dates,y:s.y,name:'Aço CRC China (USD/TON)',...lineCfg('#007bff')}],axisLayout('USD/TON',xt),{responsive:true});
  renderSummary('summary-crc', RAW.date, RAW.crc);
}
function drawIron(){
  const m=RANGE_TO_MONTHS[RANGES.iron];
  const s=sliceByMonths(RAW.date,{y:RAW.iron},m); const xt=evenMonthTicksWithYear(s.dates);
  Plotly.newPlot('chartIron',[{x:s.dates,y:s.y,name:'Minério de Ferro (USD/TON)',...lineCfg('#ff6f00')}],axisLayout('USD/TON',xt),{responsive:true});
  renderSummary('summary-iron', RAW.date, RAW.iron);
}
function drawFreight(){
  const m=RANGE_TO_MONTHS[RANGES.freight];
  const s=sliceByMonths(RAW.freight_dates,{y:RAW.freight},m); const xt=evenMonthTicksWithYear(s.dates);
  Plotly.newPlot('chartFreight',[{x:s.dates,y:s.y,name:'Frete Marítimo (USD/TEU)',...lineCfg('#00bfa6')}],axisLayout('USD/TEU',xt),{responsive:true});
  renderSummaryFreight('summary-freight', RAW.freight_dates, RAW.freight);
}
function drawFX(){
  const m=RANGE_TO_MONTHS[RANGES.fx];
  const s=sliceByMonths(RAW.date,{brl:RAW.usdbrl,cny:RAW.usdcny},m); const xt=evenMonthTicksWithYear(s.dates);
  const minB=Math.min(...s.brl.filter(v=>v!=null)), maxB=Math.max(...s.brl.filter(v=>v!=null));
  const minC=Math.min(...s.cny.filter(v=>v!=null)), maxC=Math.max(...s.cny.filter(v=>v!=null));
  Plotly.newPlot('chartFX',[
    {x:s.dates,y:s.brl,name:'USD/BRL',...lineCfg('#7e57c2')},
    {x:s.dates,y:s.cny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/BRL', xt),
    yaxis:{...axisLayout('').yaxis,title:'USD/BRL',range:[minB*0.98,maxB*1.02]},
    yaxis2:{title:'USD/CNY',overlaying:'y',side:'right',range:[minC*0.98,maxC*1.02],tickfont:{size:isMobile()?10:12}}
  },{responsive:true});
  renderSummaryFX('summary-fx', RAW.date, RAW.usdbrl, RAW.usdcny);
}

/* ====== RANGE BUTTONS ====== */
function wireRanges(){
  const map=[['ranges-geral','geral',drawGeral],['ranges-crc','crc',drawCRC],['ranges-iron','iron',drawIron],['ranges-freight','freight',drawFreight],['ranges-fx','fx',drawFX]];
  for(const [rid,key,fn] of map){
    const bar=document.getElementById(rid);
    bar.addEventListener('click',e=>{
      const b=e.target.closest('button'); if(!b) return;
      const sel=b.dataset.range; if(!sel) return;
      RANGES[key]=sel; [...bar.querySelectorAll('button')].forEach(x=>x.classList.toggle('active',x===b));
      fn();
    });
  }
}

/* ====== BOOT ====== */
(async function(){
  const rows = await loadCSV(CSV_URL);
  const base = normalize(rows);
  const redFreight = monthlyReduceFreight(base.date, base.freight_raw);
  RAW = {...base, freight_dates:redFreight.dates, freight:redFreight.values};

  // draw all with default ranges
  wireRanges();
  drawGeral(); drawCRC(); drawIron(); drawFreight(); drawFX();
})();
</script>
</body>
</html>
