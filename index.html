<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>√çndices Moveleiro ‚Äî Dashboard v4.3</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<!-- PDF export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
:root{
  --bg:#dfe1e1; --card:#fff; --shadow:0 3px 10px rgba(0,0,0,.08);
  --title-bg:#000; --title-fg:#fff; --accent:#f5b95f; --accent-border:#e5be74;
  --sticky-bg: rgba(0,0,0,0.9); /* translucent black */
}
*{box-sizing:border-box}
body{background:var(--bg);font-family:Inter,Arial,sans-serif;color:#111;margin:72px 24px 24px}

/* Sticky header */
.sticky{
  position:fixed; top:0; left:0; right:0; z-index:1000;
  background:var(--sticky-bg); color:#fff;
  padding:10px 14px; display:flex; align-items:center; gap:12px;
}
.sticky .title{font-weight:700}
.sticky .meta{font-size:12px; opacity:.9}
.sticky .actions{margin-left:auto; display:flex; gap:8px}
.sticky .btn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:6px 10px; border-radius:8px; font-weight:600; cursor:pointer; font-size:12px;
}
.sticky .btn:hover{background:#000;color:#fff;border-color:#000}

/* Sections & cards */
section{margin-bottom:18px}
.titlebar{
  background:var(--title-bg); color:var(--title-fg);
  padding:12px 16px; border-radius:6px 6px 0 0; font-weight:600;
  display:flex; align-items:center; justify-content:space-between; user-select:none;
}
.titlebar.collapsible{cursor:pointer}
.titlebar .caret{font-size:14px; opacity:.85}

/* Collapsible card with fast animation */
.card-wrap{overflow:hidden; transition:max-height .15s ease-out}
.card{
  background:var(--card);box-shadow:var(--shadow);border-radius:0 0 10px 10px;padding:14px;
}

/* Range bar + export buttons */
.rangebar{display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 10px}
.rbtn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:6px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-size:14px;
}
.rbtn.active, .rbtn:hover{background:#000;color:#fff;border-color:#000}
.rbtn.icon{padding:6px 10px}

#chartGeral{width:100%;height:560px}
.chart{width:100%;height:420px}

.badge{background:#fff;border:1px solid #e5e5e5;padding:6px 10px;border-radius:8px;font-size:12px}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.year-block{background:#f8f9fb;border-left:6px solid var(--accent);padding:10px 14px;border-radius:8px;box-shadow:var(--shadow)}
.year-title{font-weight:600;margin-bottom:6px;color:#222}
.year-block ul{list-style:none;padding-left:0;margin:0}
.last-month{grid-column:1/-1;margin-top:10px;color:#111;font-weight:600}

/* Mobile */
@media (max-width:720px){
  body{margin:64px 8px 8px}
  #chartGeral{height:400px}
  .chart{height:320px}
  .summary-grid{grid-template-columns:1fr}
  .year-block,.last-month{font-size:14px}
  .sticky{padding:10px 10px}
}
</style>
</head>
<body>

<!-- Sticky header -->
<div class="sticky">
  <div class="title">√çndices Moveleiro <span style="opacity:.7">v4.3</span></div>
  <div class="meta" id="stickyLastUpdate">√öltima atualiza√ß√£o: ‚Äî</div>
  <div class="actions">
    <button class="btn" id="btnExpandAll">Expandir tudo</button>
    <button class="btn" id="btnCollapseAll">Recolher tudo</button>
  </div>
</div>

<!-- ===== MAIN (now collapsible; starts open) ===== -->
<section id="geral">
  <div class="titlebar collapsible" data-target="geral-card">
    <span>√çndices Moveleiro</span>
    <span class="caret" id="caret-geral">‚ñº</span>
  </div>
  <div id="geral-card" class="card-wrap" style="max-height: 2000px;">
    <div class="card">
      <div class="rangebar" id="range-geral">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <button class="rbtn icon" data-export="png" title="Exportar PNG">PNG üì∏</button>
        <button class="rbtn icon" data-export="pdf" title="Exportar PDF (paisagem)">PDF</button>
        <span id="lastUpdate" class="badge" style="margin-left:auto"></span>
      </div>
      <div id="chartGeral"></div>
      <div id="summaryGeral" class="summary-grid"></div>
    </div>
  </div>
</section>

<!-- ===== COLLAPSIBLE: CRC ===== -->
<section id="crc">
  <div class="titlebar collapsible" data-target="crc-card">
    <span>A√ßo CRC China (USD/TON)</span><span class="caret" id="caret-crc">‚ñ∂</span>
  </div>
  <div id="crc-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-crc">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <button class="rbtn icon" data-export="png" title="Exportar PNG">PNG üì∏</button>
        <button class="rbtn icon" data-export="pdf" title="Exportar PDF (paisagem)">PDF</button>
      </div>
      <div id="chartCRC" class="chart"></div>
      <div id="summaryCRC" class="summary-grid"></div>
    </div>
  </div>
</section>

<!-- ===== COLLAPSIBLE: IRON ===== -->
<section id="iron">
  <div class="titlebar collapsible" data-target="iron-card">
    <span>Min√©rio de Ferro (USD/TON)</span><span class="caret" id="caret-iron">‚ñ∂</span>
  </div>
  <div id="iron-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-iron">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <button class="rbtn icon" data-export="png" title="Exportar PNG">PNG üì∏</button>
        <button class="rbtn icon" data-export="pdf" title="Exportar PDF (paisagem)">PDF</button>
      </div>
      <div id="chartIron" class="chart"></div>
      <div id="summaryIron" class="summary-grid"></div>
    </div>
  </div>
</section>

<!-- ===== COLLAPSIBLE: FREIGHT ===== -->
<section id="freight">
  <div class="titlebar collapsible" data-target="freight-card">
    <span>Frete Mar√≠timo (USD/TEU)</span><span class="caret" id="caret-freight">‚ñ∂</span>
  </div>
  <div id="freight-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-freight">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <button class="rbtn icon" data-export="png" title="Exportar PNG">PNG üì∏</button>
        <button class="rbtn icon" data-export="pdf" title="Exportar PDF (paisagem)">PDF</button>
      </div>
      <div id="chartFreight" class="chart"></div>
      <div id="summaryFreight" class="summary-grid"></div>
    </div>
  </div>
</section>

<!-- ===== COLLAPSIBLE: FX ===== -->
<section id="fx">
  <div class="titlebar collapsible" data-target="fx-card">
    <span>Taxas de C√¢mbio (USD/BRL e USD/CNY)</span><span class="caret" id="caret-fx">‚ñ∂</span>
  </div>
  <div id="fx-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-fx">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <button class="rbtn icon" data-export="png" title="Exportar PNG">PNG üì∏</button>
        <button class="rbtn icon" data-export="pdf" title="Exportar PDF (paisagem)">PDF</button>
      </div>
      <div id="chartFX" class="chart"></div>
      <div id="summaryFX" class="summary-grid"></div>
    </div>
  </div>
</section>

<script>
/* ===== Data loading ===== */
const CSV_URL="data/indices_moveleiro.csv";
let RAW=null;
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

function toNumber(v){ if(v==null||v==="")return null; if(typeof v==="number")return v;
  const n=parseFloat(String(v).replace(",",".").trim()); return Number.isFinite(n)?n:null; }
function normalizeRow(r){ return {
  date:r.date, crc:toNumber(r.CRC_China_USD_ton), iron:toNumber(r.Iron_Ore_USD_ton),
  freight:toNumber(r.Sea_Freight_USD_ton), usdbrl:toNumber(r.USD_BRL_buy), usdcny:toNumber(r.USD_CNY)
};}
function loadCSV(){
  return new Promise((res,rej)=>{
    Papa.parse(`${CSV_URL}?v=${Date.now()}`,{
      download:true, header:true, complete:(r)=>{
        const rows=r.data.filter(x=>x&&x.date);
        const n=rows.map(normalizeRow);
        const o={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};
        n.forEach(v=>{ o.date.push(v.date); o.crc.push(v.crc); o.iron.push(v.iron);
          o.freight.push(v.freight); o.usdbrl.push(v.usdbrl); o.usdcny.push(v.usdcny); });
        res(o);
      }, error:rej
    });
  });
}

/* ===== Utilities ===== */
function monthTicks(dates){
  const seen=new Set(), tickvals=[], ticktext=[];
  for(const x of dates){ const dt=new Date(x), key=dt.getFullYear()+"-"+(dt.getMonth()+1);
    if(!seen.has(key)){ seen.add(key); tickvals.push(x); ticktext.push(PT_ABBR[dt.getMonth()]); } }
  return {tickvals, ticktext};
}
function sliceByMonths(dates, arraysObj, months){
  if(months==null) return {dates:[...dates], ...Object.fromEntries(Object.keys(arraysObj).map(k=>[k,[...arraysObj[k]]]))};
  const last=new Date(dates[dates.length-1]);
  const from=new Date(last); from.setMonth(from.getMonth()-months);
  const ix=dates.findIndex(d=>new Date(d)>=from);
  const start = ix<0 ? 0 : ix;
  const outDates = dates.slice(start);
  const outObj = {};
  for(const k in arraysObj) outObj[k]= arraysObj[k].slice(start);
  return {dates:outDates, ...outObj};
}
function quarterChanges(dates, vals){
  const yearly={};
  for(let i=0;i<dates.length;i++){
    const dt=new Date(dates[i]); const y=dt.getFullYear(); const q=Math.floor(dt.getMonth()/3)+1;
    yearly[y]=yearly[y]||{1:[],2:[],3:[],4:[]}; yearly[y][q].push(vals[i]);
  }
  const out={};
  for(const y in yearly){
    out[y]={};
    for(let q=1;q<=4;q++){
      const a=yearly[y][q]; if(!a.length){ out[y][q]=null; continue; }
      const f=a[0], l=a[a.length-1]; out[y][q]=(f&&l)?((l-f)/f*100):null;
    }
  }
  return out;
}
function lastMonthLine(dates, vals){
  if(dates.length<2) return "";
  const d1=new Date(dates.at(-2)), d2=new Date(dates.at(-1));
  const v1=vals.at(-2), v2=vals.at(-1); if(!v1||!v2) return "";
  const pct=((v2-v1)/v1*100).toFixed(1);
  return `√öltimo m√™s (${PT_ABBR[d1.getMonth()]} ‚Äì ${PT_ABBR[d2.getMonth()]} ${d2.getFullYear()}): ${pct>0?"+":""}${pct}%`;
}
function renderSummary(containerId, qData, dates, vals){
  const el=document.getElementById(containerId); if(!el) return;
  const yrs=Object.keys(qData).map(Number).sort((a,b)=>b-a);
  const [y1,y2]=yrs.length>=2?[yrs[0],yrs[1]]:[yrs[0],yrs[0]];
  const fmt=v=>v==null?"n/d":(v>=0?"+":"")+v.toFixed(1)+"%";
  const block=y=>`<div class='year-block'><div class='year-title'>${y}</div><ul>${
    [1,2,3,4].map(q=>`<li>${q}¬∫ trimestre: ${fmt((qData[y]||{})[q])}</li>`).join("")
  }</ul></div>`;
  el.innerHTML = `${block(y1)}${block(y2)}<div class='last-month'>${lastMonthLine(dates,vals)}</div>`;
}

/* ===== Global state for per-chart ranges ===== */
const RANGES = {geral:"Tudo", crc:"Tudo", iron:"Tudo", freight:"Tudo", fx:"Tudo"}; // 3M,6M,1A,5A,Tudo
const RANGE_TO_MONTHS = { "3M":3, "6M":6, "1A":12, "5A":60, "Tudo":null };

/* ===== Plot helpers ===== */
function lineCfg(color){ return {mode:'lines+markers', line:{shape:'spline',smoothing:.6,width:2.2,color:color}, marker:{size:8,line:{width:1,color:'#fff'}}}; }
const plotConfig={responsive:true};

/* ===== Drawers ===== */
function drawGeral(){
  const m = RANGE_TO_MONTHS[RANGES.geral];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc, iron:RAW.iron, freight:RAW.freight, usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, m);
  const D = {date:sliced.dates, ...sliced};
  const {tickvals,ticktext}=monthTicks(D.date);
  const sticky=document.getElementById('stickyLastUpdate');
  const lastEl=document.getElementById('lastUpdate');
  if (RAW.date.length){
    const dt=new Date(RAW.date.at(-1));
    const txt=`√öltima atualiza√ß√£o: ${dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
    if (sticky) sticky.textContent=txt;
    if (lastEl) lastEl.textContent=txt;
  }
  Plotly.newPlot('chartGeral',[
    {x:D.date,y:D.crc,name:'A√ßo CRC China (USD/TON)',...lineCfg('#007bff')},
    {x:D.date,y:D.iron,name:'Min√©rio de Ferro (USD/TON)',...lineCfg('#ff6f00')},
    {x:D.date,y:D.freight,name:'Frete Mar√≠timo (USD/TEU)',...lineCfg('#00bfa6')},
    {x:D.date,y:D.usdbrl,name:'USD/BRL',yaxis:'y2',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    hovermode:'x unified', legend:{orientation:'h',y:1.12},
    xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},
    yaxis:{gridcolor:'#e9ecef',zeroline:false,title:'USD/TON (CRC, Min√©rio, Frete)'},
    yaxis2:{title:'C√¢mbio (USD/BRL, USD/CNY)',overlaying:'y',side:'right'},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff'
  }, plotConfig);
  renderSummary('summaryGeral', quarterChanges(RAW.date, RAW.crc), RAW.date, RAW.crc);
}
function drawCRC(){
  const m = RANGE_TO_MONTHS[RANGES.crc];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc}, m);
  const D = {date:sliced.dates, y:sliced.crc};
  const {tickvals,ticktext}=monthTicks(D.date);
  Plotly.newPlot('chartCRC',[{x:D.date,y:D.y,name:'A√ßo CRC China (USD/TON)',...lineCfg('#007bff')}],
    {hovermode:'x unified',xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},yaxis:{gridcolor:'#e9ecef',zeroline:false,title:'USD/TON'},paper_bgcolor:'#fff',plot_bgcolor:'#fff'}, plotConfig);
  renderSummary('summaryCRC', quarterChanges(RAW.date, RAW.crc), RAW.date, RAW.crc);
}
function drawIron(){
  const m = RANGE_TO_MONTHS[RANGES.iron];
  const sliced = sliceByMonths(RAW.date, {iron:RAW.iron}, m);
  const D = {date:sliced.dates, y:sliced.iron};
  const {tickvals,ticktext}=monthTicks(D.date);
  Plotly.newPlot('chartIron',[{x:D.date,y:D.y,name:'Min√©rio de Ferro (USD/TON)',...lineCfg('#ff6f00')}],
    {hovermode:'x unified',xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},yaxis:{gridcolor:'#e9ecef',zeroline:false,title:'USD/TON'},paper_bgcolor:'#fff',plot_bgcolor:'#fff'}, plotConfig);
  renderSummary('summaryIron', quarterChanges(RAW.date, RAW.iron), RAW.date, RAW.iron);
}
function drawFreight(){
  const m = RANGE_TO_MONTHS[RANGES.freight];
  const sliced = sliceByMonths(RAW.date, {freight:RAW.freight}, m);
  const D = {date:sliced.dates, y:sliced.freight};
  const {tickvals,ticktext}=monthTicks(D.date);
  Plotly.newPlot('chartFreight',[{x:D.date,y:D.y,name:'Frete Mar√≠timo (USD/TEU)',...lineCfg('#00bfa6')}],
    {hovermode:'x unified',xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},yaxis:{gridcolor:'#e9ecef',zeroline:false,title:'USD/TEU'},paper_bgcolor:'#fff',plot_bgcolor:'#fff'}, plotConfig);
  renderSummary('summaryFreight', quarterChanges(RAW.date, RAW.freight), RAW.date, RAW.freight);
}
function drawFX(){
  const m = RANGE_TO_MONTHS[RANGES.fx];
  const sliced = sliceByMonths(RAW.date, {usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, m);
  const D = {date:sliced.dates, usdbrl:sliced.usdbrl, usdcny:sliced.usdcny};
  const {tickvals,ticktext}=monthTicks(D.date);
  const minB=Math.min(...D.usdbrl.filter(v=>v!=null)), maxB=Math.max(...D.usdbrl.filter(v=>v!=null));
  const minC=Math.min(...D.usdcny.filter(v=>v!=null)), maxC=Math.max(...D.usdcny.filter(v=>v!=null));
  Plotly.newPlot('chartFX',[
    {x:D.date,y:D.usdbrl,name:'USD/BRL',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    hovermode:'x unified', legend:{orientation:'h',y:1.12},
    xaxis:{showgrid:false,tickmode:'array',tickvals,ticktext},
    yaxis:{gridcolor:'#e9ecef',zeroline:false,title:'USD/BRL',range:[minB*0.98, maxB*1.02]},
    yaxis2:{title:'USD/CNY',overlaying:'y',side:'right',range:[minC*0.98, maxC*1.02]},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff'
  }, plotConfig);
  renderSummary('summaryFX', quarterChanges(RAW.date, RAW.usdbrl), RAW.date, RAW.usdbrl);
}

/* ===== Accordion (with auto-scroll + fast animation) ===== */
function setExpanded(cardWrap, caretEl, expand){
  if (expand){
    cardWrap.style.display = 'block';
    // ensure correct full height for animation
    cardWrap.style.maxHeight = '1px';
    requestAnimationFrame(()=>{
      cardWrap.style.maxHeight = cardWrap.scrollHeight + 'px';
    });
    if (caretEl) caretEl.textContent = '‚ñº';
  } else {
    cardWrap.style.maxHeight = '0';
    if (caretEl) caretEl.textContent = '‚ñ∂';
    // hide after animation
    setTimeout(()=>{ if(cardWrap.style.maxHeight==='0px') cardWrap.style.display='none'; }, 160);
  }
}
function initAccordion(){
  document.querySelectorAll('.titlebar.collapsible').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const id = tb.getAttribute('data-target');
      const cardWrap = document.getElementById(id);
      const caret = tb.querySelector('.caret');
      const willOpen = (cardWrap.style.display==='none' || cardWrap.style.maxHeight==='0px' || !cardWrap.style.maxHeight);
      setExpanded(cardWrap, caret, willOpen);
      if (willOpen){
        // re-render appropriate chart + auto-scroll into view
        if(id==='geral-card') { drawGeral(); document.getElementById('geral').scrollIntoView({behavior:'smooth', block:'start'}); }
        if(id==='crc-card')   { drawCRC();  document.getElementById('crc').scrollIntoView({behavior:'smooth', block:'start'}); }
        if(id==='iron-card')  { drawIron(); document.getElementById('iron').scrollIntoView({behavior:'smooth', block:'start'}); }
        if(id==='freight-card'){drawFreight(); document.getElementById('freight').scrollIntoView({behavior:'smooth', block:'start'}); }
        if(id==='fx-card')    { drawFX();   document.getElementById('fx').scrollIntoView({behavior:'smooth', block:'start'}); }
      }
    });
  });

  // Set initial states: geral open, others closed
  setExpanded(document.getElementById('geral-card'), document.getElementById('caret-geral'), true);
  setExpanded(document.getElementById('crc-card'), document.getElementById('caret-crc'), false);
  setExpanded(document.getElementById('iron-card'), document.getElementById('caret-iron'), false);
  setExpanded(document.getElementById('freight-card'), document.getElementById('caret-freight'), false);
  setExpanded(document.getElementById('fx-card'), document.getElementById('caret-fx'), false);

  // Expand/Collapse all
  document.getElementById('btnExpandAll').addEventListener('click', ()=>{
    [['geral-card','caret-geral'],['crc-card','caret-crc'],['iron-card','caret-iron'],['freight-card','caret-freight'],['fx-card','caret-fx']].forEach(([id, cid])=>{
      setExpanded(document.getElementById(id), document.getElementById(cid), true);
    });
    // redraw for proper sizing
    drawGeral(); drawCRC(); drawIron(); drawFreight(); drawFX();
  });
  document.getElementById('btnCollapseAll').addEventListener('click', ()=>{
    [['geral-card','caret-geral'],['crc-card','caret-crc'],['iron-card','caret-iron'],['freight-card','caret-freight'],['fx-card','caret-fx']].forEach(([id, cid])=>{
      setExpanded(document.getElementById(id), document.getElementById(cid), false);
    });
  });
}

/* ===== Range selectors ===== */
function setRangeActive(rangeBarId, key){
  const bar=document.getElementById(rangeBarId);
  bar.querySelectorAll('.rbtn[data-range]').forEach(b=>b.classList.toggle('active', b.dataset.range===key));
}
function initRanges(){
  const map = [
    ['range-geral','geral',drawGeral],
    ['range-crc','crc',drawCRC],
    ['range-iron','iron',drawIron],
    ['range-freight','freight',drawFreight],
    ['range-fx','fx',drawFX],
  ];
  map.forEach(([rid, key, drawer])=>{
    const bar = document.getElementById(rid);
    bar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.rbtn');
      if(!btn) return;
      if (btn.dataset.range){
        const sel = btn.dataset.range;
        RANGES[key] = sel; setRangeActive(rid, sel); drawer();
      } else if (btn.dataset.export){
        const type = btn.dataset.export;
        const section = bar.closest('section');
        if (type==='pdf') exportSectionPDF(section);
        if (type==='png') exportSectionPNG(section);
      }
    });
  });
}

/* ===== Exports ===== */
async function exportSectionPDF(section){
  const { jsPDF } = window.jspdf;
  const card = section.querySelector('.card'); // export only content
  // Wait a tick so plots finalize sizing
  await new Promise(r=>setTimeout(r,300));
  const canvas = await html2canvas(card, {scale:2, useCORS:true, windowWidth: card.scrollWidth, windowHeight: card.scrollHeight});
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});
  const pw = pdf.internal.pageSize.getWidth();
  const ph = pdf.internal.pageSize.getHeight();
  // Fit whole card on a single page without cutting
  const ratioW = pw / canvas.width;
  const ratioH = ph / canvas.height;
  const ratio = Math.min(ratioW, ratioH);
  const w = canvas.width * ratio;
  const h = canvas.height * ratio;
  const x = (pw - w)/2;
  const y = (ph - h)/2;
  pdf.addImage(img, 'PNG', x, y, w, h);
  pdf.save(`${section.id}_indices_moveleiro.pdf`);
}
function exportSectionPNG(section){
  // Find first plotly chart within the section
  const plot = section.querySelector('.js-plotly-plot');
  if(!plot){ alert('N√£o encontrei um gr√°fico para exportar.'); return; }
  Plotly.downloadImage(plot, {format:'png', filename:`${section.id}_chart`, width:1200, height:700, scale:2});
}

/* ===== Boot ===== */
(async function(){
  RAW = await loadCSV();
  initAccordion();
  initRanges();

  // Initial active buttons + draws
  setRangeActive('range-geral', RANGES.geral); drawGeral();
  setRangeActive('range-crc', RANGES.crc);
  setRangeActive('range-iron', RANGES.iron);
  setRangeActive('range-freight', RANGES.freight);
  setRangeActive('range-fx', RANGES.fx);
})();
</script>
</body>
</html>
