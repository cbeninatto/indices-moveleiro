<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Índices Moveleiro — Dashboard v4.7</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

:root{
  --bg:#dfe1e1;
  --card:#fff;
  --shadow:0 3px 10px rgba(0,0,0,.08);
  --title-bg:#000;
  --title-fg:#fff;
  --accent:#f5b95f;
  --accent-border:#e5be74;
  --header-bg:rgba(0,0,0,0.9);
}

*{box-sizing:border-box}
body{background:var(--bg);font-family:Inter,Arial,sans-serif;color:#111;margin:24px}

/* Header (non-sticky) */
.header{
  background:var(--header-bg); color:#fff; border-radius:10px;
  padding:12px 14px; display:flex; align-items:center; gap:12px; margin-bottom:16px;
}
.header .title{font-weight:700}
.header .meta{font-size:12px; opacity:.9}
.header .spacer{flex:1}
.header .btn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:8px 14px; border-radius:10px; font-weight:700; cursor:pointer; font-size:14px;
}
.header .btn:hover{background:#000;color:#fff;border-color:#000}

/* Sections */
section{margin-bottom:18px}
.titlebar{
  background:var(--title-bg); color:var(--title-fg);
  padding:12px 16px; border-radius:6px 6px 0 0; font-weight:600;
  display:flex; align-items:center; justify-content:space-between; user-select:none;
}
.titlebar.collapsible{cursor:pointer}
.titlebar .caret{font-size:14px; opacity:.85}

.card-wrap{overflow:hidden; transition:max-height .15s ease-out}
.card{
  background:var(--card);box-shadow:var(--shadow);border-radius:0 0 10px 10px;padding:14px;
}

/* Range + inline info */
.rangebar{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  margin: 6px 0 10px
}
.rbtn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:6px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-size:14px;
}
.rbtn.active, .rbtn:hover{background:#000;color:#fff;border-color:#000}
.info-inline{margin-left:auto; font-size:12px; color:#111; white-space:nowrap}

/* Charts: desktop 480px, mobile 460px */
#chartGeral{width:100%;height:480px}
.chart{width:100%;height:480px}

/* Summaries */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.year-block{background:#f8f9fb;border-left:6px solid var(--accent);padding:10px 14px;border-radius:8px;box-shadow:var(--shadow)}
.year-title{font-weight:600;margin-bottom:6px;color:#222}
.year-block ul{list-style:none;padding-left:0;margin:0}
.year-block li{margin:2px 0}
.last-month{grid-column:1/-1;margin-top:10px;color:#111;font-weight:600}

/* Mobile */
@media (max-width:720px){
  body{margin:12px}
  #chartGeral{height:460px}
  .chart{height:460px}
  .summary-grid{grid-template-columns:1fr}
  .year-block,.last-month{font-size:13px}
  .header{flex-wrap:wrap; gap:8px}
  .info-inline{white-space:normal}
}
</style>
</head>
<body>

<div class="header">
  <div class="title">Índices Moveleiro <span style="opacity:.7">v4.7</span></div>
  <div class="meta" id="lastUpdateHeader">Última atualização: —</div>
  <div class="spacer"></div>
  <button class="btn" id="btnExportAll">Exportar PDF</button>
</div>

<section id="geral">
  <div class="titlebar collapsible" data-target="geral-card">
    <span>Visão Geral</span>
    <span class="caret" id="caret-geral">▼</span>
  </div>
  <div id="geral-card" class="card-wrap" style="max-height: 2000px;">
    <div class="card">
      <div class="rangebar" id="range-geral">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <!-- No "Última atualização" here anymore -->
      </div>
      <div id="chartGeral"></div>
    </div>
  </div>
</section>

<section id="crc">
  <div class="titlebar collapsible" data-target="crc-card">
    <span>Aço CRC China (USD/TON)</span><span class="caret" id="caret-crc">▶</span>
  </div>
  <div id="crc-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-crc">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <span id="info-crc" class="info-inline">Tudo  -  Variação: —</span>
      </div>
      <div id="chartCRC" class="chart"></div>
      <div id="summaryCRC" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="iron">
  <div class="titlebar collapsible" data-target="iron-card">
    <span>Minério de Ferro (USD/TON)</span><span class="caret" id="caret-iron">▶</span>
  </div>
  <div id="iron-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-iron">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <span id="info-iron" class="info-inline">Tudo  -  Variação: —</span>
      </div>
      <div id="chartIron" class="chart"></div>
      <div id="summaryIron" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="freight">
  <div class="titlebar collapsible" data-target="freight-card">
    <span>Frete Marítimo (USD/TEU)</span><span class="caret" id="caret-freight">▶</span>
  </div>
  <div id="freight-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-freight">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <span id="info-freight" class="info-inline">Tudo  -  Variação: —</span>
      </div>
      <div id="chartFreight" class="chart"></div>
      <div id="summaryFreight" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="fx">
  <div class="titlebar collapsible" data-target="fx-card">
    <span>Taxas de Câmbio (USD/BRL e USD/CNY)</span><span class="caret" id="caret-fx">▶</span>
  </div>
  <div id="fx-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-fx">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
        <span id="info-fx" class="info-inline">Tudo  -  Variação: USD/BRL — | USD/CNY —</span>
      </div>
      <div id="chartFX" class="chart"></div>
      <div id="summaryFX" class="summary-grid"></div>
    </div>
  </div>
</section>

<script>
const CSV_URL="data/indices_moveleiro.csv";
let RAW=null;
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const isMobile = () => window.innerWidth < 720;

function toNumber(v){ if(v==null||v==="")return null; if(typeof v==="number")return v;
  const n=parseFloat(String(v).replace(",",".").trim()); return Number.isFinite(n)?n:null; }
function normalizeRow(r){ return {
  date:r.date, crc:toNumber(r.CRC_China_USD_ton), iron:toNumber(r.Iron_Ore_USD_ton),
  freight:toNumber(r.Sea_Freight_USD_ton), usdbrl:toNumber(r.USD_BRL_buy), usdcny:toNumber(r.USD_CNY)
};}
function loadCSV(){
  return new Promise((res,rej)=>{
    Papa.parse(`${CSV_URL}?v=${Date.now()}`,{
      download:true, header:true, complete:(r)=>{
        const rows=r.data.filter(x=>x&&x.date);
        const n=rows.map(normalizeRow);
        const o={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};
        n.forEach(v=>{ o.date.push(v.date); o.crc.push(v.crc); o.iron.push(v.iron);
          o.freight.push(v.freight); o.usdbrl.push(v.usdbrl); o.usdcny.push(v.usdcny); });
        res(o);
      }, error:rej
    });
  });
}

function evenMonthTicksWithYear(dates){
  const seen=new Set(), tickvals=[], ticktext=[];
  for(const iso of dates){
    const dt=new Date(iso); const m=dt.getMonth()+1; const y=String(dt.getFullYear()).slice(-2);
    const key = dt.getFullYear()+"-"+m;
    if(m%2===0 && !seen.has(key)){ seen.add(key); tickvals.push(iso); ticktext.push(PT_ABBR[dt.getMonth()]+" "+y); }
  }
  return {tickvals, ticktext};
}

function sliceByMonths(dates, arraysObj, months){
  if(months==null) return {dates:[...dates], ...Object.fromEntries(Object.keys(arraysObj).map(k=>[k,[...arraysObj[k]]]))};
  const last=new Date(dates[dates.length-1]);
  const from=new Date(last); from.setMonth(from.getMonth()-months);
  const ix=dates.findIndex(d=>new Date(d)>=from);
  const start = ix<0 ? 0 : ix;
  const outDates = dates.slice(start);
  const outObj = {};
  for(const k in arraysObj) outObj[k]= arraysObj[k].slice(start);
  return {dates:outDates, ...outObj};
}

function quarterChanges(dates, vals){
  const yearly={};
  for(let i=0;i<dates.length;i++){
    const dt=new Date(dates[i]); const y=dt.getFullYear(); const q=Math.floor(dt.getMonth()/3)+1;
    yearly[y]=yearly[y]||{1:[],2:[],3:[],4:[]}; yearly[y][q].push(vals[i]);
  }
  const out={};
  for(const y in yearly){
    out[y]={};
    for(let q=1;q<=4;q++){
      const a=yearly[y][q]; if(!a.length){ out[y][q]=null; continue; }
      const f=a[0], l=a[a.length-1]; out[y][q]=(f&&l)?((l-f)/f*100):null;
    }
  }
  return out;
}
function quarterChangesPair(dates, v1, v2){
  return { a: quarterChanges(dates, v1), b: quarterChanges(dates, v2) };
}

function lastMonthLineFX(dates, v1, v2){
  if(dates.length<2) return "";
  const d1=new Date(dates.at(-2)), d2=new Date(dates.at(-1));
  const a1=v1.at(-2), a2=v1.at(-1); const b1=v2.at(-2), b2=v2.at(-1);
  if(a1==null||a2==null||b1==null||b2==null) return "";
  const pa=((a2-a1)/a1*100), pb=((b2-b1)/b1*100);
  return `Último mês (${PT_ABBR[d1.getMonth()]} – ${PT_ABBR[d2.getMonth()]} ${d2.getFullYear()}):<br/>USD/BRL: ${(pa>=0?"+":"")+pa.toFixed(1).replace(".",",")} %<br/>USD/CNY: ${(pb>=0?"+":"")+pb.toFixed(1).replace(".",",")} %`;
}

function renderSummary(containerId, qData, dates, vals){
  const el=document.getElementById(containerId); if(!el) return;
  const yrs=Object.keys(qData).map(Number).sort((a,b)=>b-a);
  const [y1,y2]=yrs.length>=2?[yrs[0],yrs[1]]:[yrs[0],yrs[0]];
  const fmt=v=>v==null?"n/d":(v>=0?"+":"")+v.toFixed(1).replace(".",",")+" %";
  const block=y=>`<div class='year-block'><div class='year-title'>${y}</div><ul>${
    [1,2,3,4].map(q=>`<li>${q}º trimestre: ${fmt((qData[y]||{})[q])}</li>`).join("")
  }</ul></div>`;
  const last = (function(){
    if(dates.length<2) return "";
    const d1=new Date(dates.at(-2)), d2=new Date(dates.at(-1));
    const v1=vals.at(-2), v2=vals.at(-1); if(v1==null||v2==null) return "";
    const pct=((v2-v1)/v1*100); const t=(pct>=0?"+":"")+pct.toFixed(1).replace(".",",")+" %";
    return `Último mês (${PT_ABBR[d1.getMonth()]} – ${PT_ABBR[d2.getMonth()]} ${d2.getFullYear()}): ${t}`;
  })();
  el.innerHTML = `${block(y1)}${block(y2)}<div class='last-month'>${last}</div>`;
}

function renderSummaryFX(containerId, dates, usdbrl, usdcny){
  const el=document.getElementById(containerId); if(!el) return;
  const {a:Qb, b:Qc} = quarterChangesPair(dates, usdbrl, usdcny);
  const yrs=Array.from(new Set(dates.map(d=>new Date(d).getFullYear()))).sort((a,b)=>b-a);
  const [y1,y2]=yrs.length>=2?[yrs[0],yrs[1]]:[yrs[0],yrs[0]];
  const fmt=v=>v==null?"n/d":(v>=0?"+":"")+v.toFixed(1).replace(".",",")+" %";
  function block(y){
    const qb=Qb[y]||{}, qc=Qc[y]||{};
    const lines=[1,2,3,4].map(q=>(
      `<li>${q}º trimestre:<br/>  USD/BRL: ${fmt(qb[q])}<br/>  USD/CNY: ${fmt(qc[q])}</li>`
    )).join("");
    return `<div class='year-block'><div class='year-title'>${y}</div><ul>${lines}</ul></div>`;
  }
  const last = lastMonthLineFX(dates, usdbrl, usdcny);
  el.innerHTML = `${block(y1)}${block(y2)}<div class='last-month'>${last}</div>`;
}

const RANGES = {geral:"Tudo", crc:"Tudo", iron:"Tudo", freight:"Tudo", fx:"Tudo"};
const RANGE_TO_MONTHS = { "3M":3, "6M":6, "1A":12, "5A":60, "Tudo":null };

function lineCfg(color){
  return {
    mode:'lines+markers',
    line:{shape:'spline',smoothing:.6,width:isMobile()?2:3.2,color:color},
    marker:{size:isMobile()?5:7,line:{width:1,color:'#fff'}}
  };
}
function axisLayout(baseTitle, xticks){
  const tf = isMobile() ? 10 : 12;
  return {
    hovermode:'x unified',
    legend:{orientation:'h', y:-0.25, font:{size:isMobile()?11:12}},
    xaxis:{showgrid:false, tickmode:'array', ...xticks, tickfont:{size:tf}, automargin:true},
    yaxis:{gridcolor:'#e9ecef', zeroline:false, title:baseTitle, tickfont:{size:tf}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    margin:{t:40,r:30,b:80,l:60}
  };
}
function formatPct(p){ return (p>=0?"+":"")+p.toFixed(1).replace(".",",")+" %"; }

function updateVariationSingle(key, labelId, series){
  const months = RANGE_TO_MONTHS[RANGES[key]];
  const sliced = sliceByMonths(RAW.date, {[key]:series}, months);
  const y = sliced[key];
  const first = y.find(v=>v!=null);
  const last  = [...y].reverse().find(v=>v!=null);
  const el = document.getElementById(labelId);
  if(!el || first==null || last==null){ if(el) el.textContent=`${RANGES[key]}  -  Variação: —`; return; }
  const pct = (last-first)/first*100;
  el.textContent = `${RANGES[key]}  -  Variação: ${formatPct(pct)}`;
}

function updateVariationFX(){
  const months = RANGE_TO_MONTHS[RANGES.fx];
  const sliced = sliceByMonths(RAW.date, {usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, months);
  const a = sliced.usdbrl, b = sliced.usdcny;
  const aF = a.find(v=>v!=null), aL = [...a].reverse().find(v=>v!=null);
  const bF = b.find(v=>v!=null), bL = [...b].reverse().find(v=>v!=null);
  const el = document.getElementById('info-fx');
  if(!el || aF==null || aL==null || bF==null || bL==null){
    if(el) el.textContent = `${RANGES.fx}  -  Variação: USD/BRL — | USD/CNY —`;
    return;
  }
  const pa=(aL-aF)/aF*100, pb=(bL-bF)/bF*100;
  el.textContent = `${RANGES.fx}  -  Variação: USD/BRL ${formatPct(pa)} | USD/CNY ${formatPct(pb)}`;
}

function drawGeral(){
  const m = RANGE_TO_MONTHS[RANGES.geral];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc, iron:RAW.iron, freight:RAW.freight, usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, m);
  const D = {date:sliced.dates, ...sliced};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  if (RAW.date.length){
    const dt=new Date(RAW.date.at(-1));
    const txt=`Última atualização: ${dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
    const lastHeader=document.getElementById('lastUpdateHeader');
    if (lastHeader) lastHeader.textContent = txt;
  }
  Plotly.newPlot('chartGeral',[
    {x:D.date,y:D.crc,name:'Aço CRC China (USD/TON)',...lineCfg('#007bff')},
    {x:D.date,y:D.iron,name:'Minério de Ferro (USD/TON)',...lineCfg('#ff6f00')},
    {x:D.date,y:D.freight,name:'Frete Marítimo (USD/TEU)',...lineCfg('#00bfa6')},
    {x:D.date,y:D.usdbrl,name:'USD/BRL',yaxis:'y2',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/TON (CRC, Minério, Frete)', {tickvals, ticktext}),
    yaxis2:{title:'Câmbio (USD/BRL, USD/CNY)', overlaying:'y', side:'right', tickfont:{size:isMobile()?10:12}, automargin:true}
  }, {responsive:true});
}

function drawCRC(){
  const m = RANGE_TO_MONTHS[RANGES.crc];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc}, m);
  const D = {date:sliced.dates, y:sliced.crc};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartCRC',[
    {x:D.date,y:D.y,name:'Aço CRC China (USD/TON)',...lineCfg('#007bff')}
  ], axisLayout('USD/TON', {tickvals, ticktext}), {responsive:true});
  renderSummary('summaryCRC', quarterChanges(RAW.date, RAW.crc), RAW.date, RAW.crc);
  updateVariationSingle('crc','info-crc', RAW.crc);
}

function drawIron(){
  const m = RANGE_TO_MONTHS[RANGES.iron];
  const sliced = sliceByMonths(RAW.date, {iron:RAW.iron}, m);
  const D = {date:sliced.dates, y:sliced.iron};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartIron',[
    {x:D.date,y:D.y,name:'Minério de Ferro (USD/TON)',...lineCfg('#ff6f00')}
  ], axisLayout('USD/TON', {tickvals, ticktext}), {responsive:true});
  renderSummary('summaryIron', quarterChanges(RAW.date, RAW.iron), RAW.date, RAW.iron);
  updateVariationSingle('iron','info-iron', RAW.iron);
}

function drawFreight(){
  const m = RANGE_TO_MONTHS[RANGES.freight];
  const sliced = sliceByMonths(RAW.date, {freight:RAW.freight}, m);
  const D = {date:sliced.dates, y:sliced.freight};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartFreight',[
    {x:D.date,y:D.y,name:'Frete Marítimo (USD/TEU)',...lineCfg('#00bfa6')}
  ], axisLayout('USD/TEU', {tickvals, ticktext}), {responsive:true});
  renderSummary('summaryFreight', quarterChanges(RAW.date, RAW.freight), RAW.date, RAW.freight);
  updateVariationSingle('freight','info-freight', RAW.freight);
}

function drawFX(){
  const m = RANGE_TO_MONTHS[RANGES.fx];
  const sliced = sliceByMonths(RAW.date, {usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, m);
  const D = {date:sliced.dates, usdbrl:sliced.usdbrl, usdcny:sliced.usdcny};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  const minB=Math.min(...D.usdbrl.filter(v=>v!=null)), maxB=Math.max(...D.usdbrl.filter(v=>v!=null));
  const minC=Math.min(...D.usdcny.filter(v=>v!=null)), maxC=Math.max(...D.usdcny.filter(v=>v!=null));
  Plotly.newPlot('chartFX',[
    {x:D.date,y:D.usdbrl,name:'USD/BRL',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/BRL', {tickvals, ticktext}),
    yaxis:{...axisLayout('').yaxis, title:'USD/BRL', range:[minB*0.98, maxB*1.02]},
    yaxis2:{title:'USD/CNY', overlaying:'y', side:'right', range:[minC*0.98, maxC*1.02], tickfont:{size:isMobile()?10:12}, automargin:true}
  }, {responsive:true});
  renderSummaryFX('summaryFX', RAW.date, RAW.usdbrl, RAW.usdcny);
  updateVariationFX();
}

function setExpanded(cardWrap, caretEl, expand){
  if (expand){
    cardWrap.style.display = 'block';
    cardWrap.style.maxHeight = '1px';
    requestAnimationFrame(()=>{ cardWrap.style.maxHeight = cardWrap.scrollHeight + 'px'; });
    if (caretEl) caretEl.textContent = '▼';
  } else {
    cardWrap.style.maxHeight = '0';
    if (caretEl) caretEl.textContent = '▶';
    setTimeout(()=>{ if(cardWrap.style.maxHeight==='0px') cardWrap.style.display='none'; }, 160);
  }
}
function initAccordion(){
  document.querySelectorAll('.titlebar.collapsible').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const id = tb.getAttribute('data-target');
      const cardWrap = document.getElementById(id);
      const caret = tb.querySelector('.caret');
      const willOpen = (cardWrap.style.display==='none' || cardWrap.style.maxHeight==='0px' || !cardWrap.style.maxHeight);
      setExpanded(cardWrap, caret, willOpen);
      if (willOpen){
        if(id==='geral-card') drawGeral();
        if(id==='crc-card')   drawCRC();
        if(id==='iron-card')  drawIron();
        if(id==='freight-card') drawFreight();
        if(id==='fx-card')    drawFX();
        tb.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });
  });

  setExpanded(document.getElementById('geral-card'), document.getElementById('caret-geral'), true);
  setExpanded(document.getElementById('crc-card'), document.getElementById('caret-crc'), false);
  setExpanded(document.getElementById('iron-card'), document.getElementById('caret-iron'), false);
  setExpanded(document.getElementById('freight-card'), document.getElementById('caret-freight'), false);
  setExpanded(document.getElementById('fx-card'), document.getElementById('caret-fx'), false);
}

function setRangeActive(rangeBarId, key){
  const bar=document.getElementById(rangeBarId);
  bar.querySelectorAll('.rbtn[data-range]').forEach(b=>b.classList.toggle('active', b.dataset.range===key));
}
function initRanges(){
  const map = [
    ['range-geral','geral',drawGeral],
    ['range-crc','crc',drawCRC],
    ['range-iron','iron',drawIron],
    ['range-freight','freight',drawFreight],
    ['range-fx','fx',drawFX],
  ];
  map.forEach(([rid, key, drawer])=>{
    const bar = document.getElementById(rid);
    bar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.rbtn');
      if(!btn) return;
      const sel = btn.dataset.range;
      if(sel){ RANGES[key] = sel; setRangeActive(rid, sel); drawer();
        if(key==='crc') updateVariationSingle('crc','info-crc', RAW.crc);
        if(key==='iron') updateVariationSingle('iron','info-iron', RAW.iron);
        if(key==='freight') updateVariationSingle('freight','info-freight', RAW.freight);
        if(key==='fx') updateVariationFX();
      }
    });
  });
}

(async function(){
  RAW = await loadCSV();
  initAccordion();
  initRanges();

  setRangeActive('range-geral', RANGES.geral); drawGeral();
  setRangeActive('range-crc', RANGES.crc);
  setRangeActive('range-iron', RANGES.iron);
  setRangeActive('range-freight', RANGES.freight);
  setRangeActive('range-fx', RANGES.fx);
})();
</script>
</body>
</html>
