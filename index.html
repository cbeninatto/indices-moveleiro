<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>√çndices Moveleiro ‚Äî Dashboard v4.1</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
:root{--bg:#dfe1e1;--card:#fff;--shadow:0 3px 10px rgba(0,0,0,.08);--title-bg:#000;--title-fg:#fff;--accent:#f5b95f;}
body{background:var(--bg);font-family:Inter,Arial,sans-serif;color:#111;margin:24px}
section{margin-bottom:34px}
.titlebar{background:var(--title-bg);color:var(--title-fg);padding:10px 16px;border-radius:6px 6px 0 0;font-weight:600}
.card{background:var(--card);box-shadow:var(--shadow);border-radius:0 0 10px 10px;padding:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:12px 0 8px}
.status{margin-left:auto;font-size:12px;color:#333;background:#fff;padding:6px 10px;border:1px solid #e5e5e5;border-radius:8px}
input[type=date],button{padding:8px 12px;border-radius:8px;border:1px solid #e5e5e5}
button{background:#f7f7f7;cursor:pointer}
#chartGeral{width:100%;height:600px}
#chartCRC,#chartIron,#chartFreight,#chartFX{width:100%;height:460px}
.badge{background:#fff;border:1px solid #e5e5e5;padding:6px 10px;border-radius:8px;font-size:12px}
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
.year-block{background:#f8f9fb;border-left:6px solid var(--accent);padding:10px 14px;border-radius:8px;box-shadow:var(--shadow)}
.year-title{font-weight:600;margin-bottom:6px;color:#222}
.year-block ul{list-style:none;padding-left:0;margin:0}
.last-month{grid-column:1/-1;margin-top:10px;color:#111;font-weight:600}

/* üì± Improved mobile layout */
@media (max-width: 720px) {
  body {
    margin: 8px;
  }
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  button, input[type=date] {
    width: 100%;
  }
  #chartGeral { height: 400px; }
  #chartCRC, #chartIron, #chartFreight, #chartFX { height: 320px; }
  .summary-grid { grid-template-columns: 1fr; }
  .year-block, .last-month { font-size: 14px; }
}
</style>
</head>
<body>

<section id="geral">
  <div class="titlebar">√çndices Moveleiro</div>
  <div class="card">
    <div class="controls">
      <label>Data inicial:<input type="date" id="start"></label>
      <label>Data final:<input type="date" id="end"></label>
      <button id="apply">Aplicar filtro</button>
      <button id="refresh">Atualizar dados üîÑ</button>
      <button id="download">Baixar CSV</button>
      <span id="info" class="badge"></span>
      <span id="lastUpdate" class="badge"></span>
      <span id="status" class="status"></span>
    </div>
    <div id="chartGeral"></div>
  </div>
</section>

<section id="crc">
  <div class="titlebar">A√ßo CRC China (USD/TON)</div>
  <div class="card">
    <div id="chartCRC"></div>
    <div id="summaryCRC" class="summary-grid"></div>
  </div>
</section>

<section id="iron">
  <div class="titlebar">Min√©rio de Ferro (USD/TON)</div>
  <div class="card">
    <div id="chartIron"></div>
    <div id="summaryIron" class="summary-grid"></div>
  </div>
</section>

<section id="freight">
  <div class="titlebar">Frete Mar√≠timo (USD/TEU)</div>
  <div class="card">
    <div id="chartFreight"></div>
    <div id="summaryFreight" class="summary-grid"></div>
  </div>
</section>

<section id="fx">
  <div class="titlebar">Taxas de C√¢mbio (USD/BRL e USD/CNY)</div>
  <div class="card">
    <div id="chartFX"></div>
    <div id="summaryFX" class="summary-grid"></div>
  </div>
</section>

<script>
const CSV_URL="data/indices_moveleiro.csv";
let RAW=null;
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
function toNumber(v){if(v==null||v==="")return null;if(typeof v==="number")return v;const n=parseFloat(String(v).replace(",",".").trim());return Number.isFinite(n)?n:null;}
function normalizeRow(r){return{date:r.date,crc:toNumber(r.CRC_China_USD_ton),iron:toNumber(r.Iron_Ore_USD_ton),freight:toNumber(r.Sea_Freight_USD_ton),usdbrl:toNumber(r.USD_BRL_buy),usdcny:toNumber(r.USD_CNY)};}
function monthTicks(d){const s=new Set(),tv=[],tt=[];for(const x of d){const dt=new Date(x),k=dt.getFullYear()+"-"+(dt.getMonth()+1);if(!s.has(k)){s.add(k);tv.push(x);tt.push(PT_ABBR[dt.getMonth()]);}}return{tickvals:tv,ticktext:tt};}
function filterData(s=null,e=null){const S=s?new Date(s):null,E=e?new Date(e):null,out={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};for(let i=0;i<RAW.date.length;i++){const d=new Date(RAW.date[i]);if((S&&d<S)||(E&&d>E))continue;for(const k in out)if(k!=="date")out[k].push(RAW[k][i]);out.date.push(RAW.date[i]);}return out;}
function loadCSV(){return new Promise((res,rej)=>{Papa.parse(`${CSV_URL}?v=${Date.now()}`,{download:true,header:true,complete:r=>{const rows=r.data.filter(x=>x&&x.date),n=rows.map(normalizeRow),o={date:[],crc:[],iron:[],freight:[],usdbrl:[],usdcny:[]};n.forEach(r=>{for(const k in o)o[k].push(r[k]);});res(o);},error:rej});});}
function calcQuarterChanges(dates,vals){const yearly={};for(let i=0;i<dates.length;i++){const d=new Date(dates[i]),y=d.getFullYear(),q=Math.floor(d.getMonth()/3)+1;yearly[y]=yearly[y]||{1:[],2:[],3:[],4:[]};yearly[y][q].push(vals[i]);}const out={};for(const y in yearly){out[y]={};for(let q=1;q<=4;q++){const a=yearly[y][q];if(!a.length){out[y][q]=null;continue;}const f=a[0],l=a[a.length-1];out[y][q]=(f&&l)?((l-f)/f*100):null;}}return out;}
function calcLastMonthLine(dates,vals){if(dates.length<2)return"";const d1=new Date(dates.at(-2)),d2=new Date(dates.at(-1)),v1=vals.at(-2),v2=vals.at(-1);if(!v1||!v2)return"";const pct=((v2-v1)/v1*100).toFixed(1);const m1=PT_ABBR[d1.getMonth()],m2=PT_ABBR[d2.getMonth()],y=d2.getFullYear();return`√öltimo m√™s (${m1} ‚Äì ${m2} ${y}): ${pct>0?"+":""}${pct}%`;}
function renderSummary(id,obj,dates,vals){const el=document.getElementById(id);if(!el)return;el.innerHTML="";const yrs=Object.keys(obj).map(Number).sort((a,b)=>b-a),[y1,y2]=yrs.length>=2?[yrs[0],yrs[1]]:[yrs[0],yrs[0]],fmt=v=>v==null?"n/d":(v>=0?"+":"")+v.toFixed(1)+"%";const block=y=>{const v=obj[y]||{};return`<div class='year-block'><div class='year-title'>${y}</div><ul>${[1,2,3,4].map(q=>`<li>${q}¬∫ trimestre: ${fmt(v[q])}</li>`).join("")}</ul></div>`;};el.innerHTML=`${block(y1)}${block(y2)}<div class='last-month'>${calcLastMonthLine(dates,vals)}</div>`;}
function drawAll(s=null,e=null){const D=filterData(s,e),{tickvals,ticktext}=monthTicks(D.date);const lineCfg=c=>({mode:"lines+markers",line:{shape:"spline",smoothing:.6,width:2.2,color:c},marker:{size:8,line:{width:1,color:"#fff"}}});const config={responsive:true};
Plotly.newPlot("chartGeral",[
  {x:D.date,y:D.crc,name:"A√ßo CRC China (USD/TON)",...lineCfg("#007bff")},
  {x:D.date,y:D.iron,name:"Min√©rio de Ferro (USD/TON)",...lineCfg("#ff6f00")},
  {x:D.date,y:D.freight,name:"Frete Mar√≠timo (USD/TEU)",...lineCfg("#00bfa6")},
  {x:D.date,y:D.usdbrl,name:"USD/BRL",yaxis:"y2",...lineCfg("#7e57c2")},
  {x:D.date,y:D.usdcny,name:"USD/CNY",yaxis:"y2",...lineCfg("#e53935")}
],{hovermode:"x unified",legend:{orientation:"h",y:1.12},xaxis:{showgrid:false,tickmode:"array",tickvals,ticktext},
yaxis:{gridcolor:"#e9ecef",zeroline:false,title:"USD/TON (CRC, Min√©rio, Frete)"},yaxis2:{title:"C√¢mbio (USD/BRL, USD/CNY)",overlaying:"y",side:"right"},paper_bgcolor:"#fff",plot_bgcolor:"#fff"},config);

const sub={hovermode:"x unified",xaxis:{showgrid:false,tickmode:"array",tickvals,ticktext},yaxis:{gridcolor:"#e9ecef",zeroline:false},paper_bgcolor:"#fff",plot_bgcolor:"#fff"};
Plotly.newPlot("chartCRC",[ {x:D.date,y:D.crc,name:"A√ßo CRC China (USD/TON)",...lineCfg("#007bff")} ],{...sub,yaxis:{...sub.yaxis,title:"USD/TON"}},config);
Plotly.newPlot("chartIron",[ {x:D.date,y:D.iron,name:"Min√©rio de Ferro (USD/TON)",...lineCfg("#ff6f00")} ],{...sub,yaxis:{...sub.yaxis,title:"USD/TON"}},config);
Plotly.newPlot("chartFreight",[ {x:D.date,y:D.freight,name:"Frete Mar√≠timo (USD/TEU)",...lineCfg("#00bfa6")} ],{...sub,yaxis:{...sub.yaxis,title:"USD/TEU"}},config);
const minB=Math.min(...D.usdbrl.filter(v=>v)),maxB=Math.max(...D.usdbrl.filter(v=>v)),minC=Math.min(...D.usdcny.filter(v=>v)),maxC=Math.max(...D.usdcny.filter(v=>v));
Plotly.newPlot("chartFX",[ {x:D.date,y:D.usdbrl,name:"USD/BRL",...lineCfg("#7e57c2")},{x:D.date,y:D.usdcny,name:"USD/CNY",yaxis:"y2",...lineCfg("#e53935")} ],
  {...sub,legend:{orientation:"h",y:1.12},yaxis:{...sub.yaxis,title:"USD/BRL",range:[minB*.98,maxB*1.02]},yaxis2:{title:"USD/CNY",overlaying:"y",side:"right",range:[minC*.98,maxC*1.02]}},config);

renderSummary("summaryCRC",calcQuarterChanges(D.date,D.crc),D.date,D.crc);
renderSummary("summaryIron",calcQuarterChanges(D.date,D.iron),D.date,D.iron);
renderSummary("summaryFreight",calcQuarterChanges(D.date,D.freight),D.date,D.freight);
renderSummary("summaryFX",calcQuarterChanges(D.date,D.usdbrl),D.date,D.usdbrl);
}
function wireUI(){document.getElementById("apply").addEventListener("click",()=>drawAll(document.getElementById("start").value||null,document.getElementById("end").value||null));
document.getElementById("refresh").addEventListener("click",async()=>{setBusy("Atualizando‚Ä¶");RAW=await loadCSV();initDates();clearBusy();drawAll();});
document.getElementById("download").addEventListener("click",()=>{const D=filterData(),csv=["date,CRC,Iron,Freight,USD/BRL,USD/CNY"];for(let i=0;i<D.date.length;i++)csv.push([D.date[i],D.crc[i],D.iron[i],D.freight[i],D.usdbrl[i],D.usdcny[i]].join(","));const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv.join("\n")],{type:"text/csv"}));a.download="indices_moveleiro_filtrado.csv";a.click();});}
function setBusy(t){document.getElementById("status").innerText=t;}
function clearBusy(){document.getElementById("status").innerText="";}
function initDates(){const s=document.getElementById("start"),e=document.getElementById("end");s.min=RAW.date[0];e.max=RAW.date.at(-1);s.value=RAW.date[0];e.value=RAW.date.at(-1);}
(async()=>{setBusy("Carregando dados‚Ä¶");RAW=await loadCSV();initDates();wireUI();clearBusy();drawAll();})();
</script>
</body>
</html>
