<!-- v4.9.2 | Último mês refined for current year only | Auto month-end filtering | © Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Índices Moveleiro — Modern Dashboard v4.9.2</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Plotly & PapaParse -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

:root{
  --bg:#dfe1e1;
  --card:#fff;
  --shadow:0 3px 10px rgba(0,0,0,.08);
  --title-bg:#000;
  --title-fg:#fff;
  --accent:#f5b95f;
  --accent-border:#e5be74;
  --header-bg:rgba(0,0,0,0.9);
}

*{box-sizing:border-box}
body{background:var(--bg);font-family:Inter,Arial,sans-serif;color:#111;margin:24px}

/* Header (non-sticky) */
.header{
  background:var(--header-bg); color:#fff; border-radius:10px;
  padding:12px 14px; display:flex; align-items:center; gap:12px; margin-bottom:16px;
}
.header .title{font-weight:700}
.header .meta{font-size:12px; opacity:.9}
.header .spacer{flex:1}
.header .btn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:8px 14px; border-radius:10px; font-weight:700; cursor:pointer; font-size:14px;
}
.header .btn:hover{background:#000;color:#fff;border-color:#000}

/* Sections */
section{margin-bottom:18px}
.titlebar{
  background:var(--title-bg); color:var(--title-fg);
  padding:12px 16px; border-radius:6px 6px 0 0; font-weight:600;
  display:flex; align-items:center; justify-content:space-between; user-select:none;
}
.titlebar.collapsible{cursor:pointer}
.titlebar .caret{font-size:14px; opacity:.85}

.card-wrap{overflow:hidden; transition:max-height .15s ease-out}
.card{
  background:var(--card);box-shadow:var(--shadow);border-radius:0 0 10px 10px;padding:14px;
}

/* Range buttons row */
.rangebar{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  margin: 6px 0 10px
}
.rbtn{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:6px 12px; border-radius:10px; font-weight:600; cursor:pointer; font-size:14px;
}
.rbtn.active, .rbtn:hover{background:#000;color:#fff;border-color:#000}

/* Variation pill styled like buttons, full width on mobile */
.varline{ width:100%; display:flex; justify-content:flex-start; margin-top:6px; }
.varpill{
  background:var(--accent); color:#000; border:1px solid var(--accent-border);
  padding:6px 12px; border-radius:10px; font-weight:600; font-size:14px;
}

/* Charts */
#chartGeral{width:100%;height:480px}
.chart{width:100%;height:480px}

/* Summaries */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.year-block{background:#f8f9fb;border-left:6px solid var(--accent);padding:10px 14px;border-radius:8px;box-shadow:var(--shadow)}
.year-title{font-weight:600;margin-bottom:6px;color:#222}
.year-block ul{list-style:none;padding-left:0;margin:0}
.year-block li{margin:2px 0}

/* 4-column FX grid */
.summary-grid.fx{
  display:grid; gap:16px; margin-top:12px;
  grid-template-columns: repeat(4, 1fr);
}
.fx-cap{font-weight:600; margin-bottom:6px; color:#333}
.fx-last{margin-top:8px; font-weight:600}

/* Mobile */
@media (max-width:1080px){
  .summary-grid.fx{grid-template-columns: repeat(2, 1fr);}
}
@media (max-width:720px){
  body{margin:12px}
  #chartGeral{height:460px}
  .chart{height:460px}
  .summary-grid{grid-template-columns:1fr}
  .summary-grid.fx{grid-template-columns:1fr 1fr}
  .year-block{font-size:13px}
  .header{flex-wrap:wrap; gap:8px}
}
@media (max-width:480px){
  .summary-grid.fx{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="title">Índices Moveleiro</div>
  <div class="meta" id="lastUpdateHeader">Última atualização: —</div>
  <div class="spacer"></div>
  <!-- Placeholder (inactive) -->
  <button class="btn" id="btnExportAll">Exportar PDF</button>
</div>

<section id="geral">
  <div class="titlebar collapsible" data-target="geral-card">
    <span>Visão Geral</span>
    <span class="caret" id="caret-geral">▼</span>
  </div>
  <div id="geral-card" class="card-wrap" style="max-height: 2000px;">
    <div class="card">
      <div class="rangebar" id="range-geral">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
      </div>
      <!-- Variation pill intentionally hidden for overview -->
      <div class="varline" id="varline-geral" style="display:none;">
        <div class="varpill" id="varpill-geral"></div>
      </div>
      <div id="chartGeral"></div>
    </div>
  </div>
</section>

<section id="crc">
  <div class="titlebar collapsible" data-target="crc-card">
    <span>Aço CRC China (USD/TON)</span><span class="caret" id="caret-crc">▶</span>
  </div>
  <div id="crc-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-crc">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
      </div>
      <div class="varline"><div class="varpill" id="varpill-crc">—</div></div>
      <div id="chartCRC" class="chart"></div>
      <div id="summaryCRC" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="iron">
  <div class="titlebar collapsible" data-target="iron-card">
    <span>Minério de Ferro (USD/TON)</span><span class="caret" id="caret-iron">▶</span>
  </div>
  <div id="iron-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-iron">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
      </div>
      <div class="varline"><div class="varpill" id="varpill-iron">—</div></div>
      <div id="chartIron" class="chart"></div>
      <div id="summaryIron" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="freight">
  <div class="titlebar collapsible" data-target="freight-card">
    <span>Frete Marítimo (USD/TEU)</span><span class="caret" id="caret-freight">▶</span>
  </div>
  <div id="freight-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-freight">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
      </div>
      <div class="varline"><div class="varpill" id="varpill-freight">—</div></div>
      <div id="chartFreight" class="chart"></div>
      <div id="summaryFreight" class="summary-grid"></div>
    </div>
  </div>
</section>

<section id="fx">
  <div class="titlebar collapsible" data-target="fx-card">
    <span>Taxas de Câmbio (USD/BRL e USD/CNY)</span><span class="caret" id="caret-fx">▶</span>
  </div>
  <div id="fx-card" class="card-wrap" style="max-height:0">
    <div class="card">
      <div class="rangebar" id="range-fx">
        <button class="rbtn" data-range="3M">3M</button>
        <button class="rbtn" data-range="6M">6M</button>
        <button class="rbtn" data-range="1A">1A</button>
        <button class="rbtn" data-range="5A">5A</button>
        <button class="rbtn active" data-range="Tudo">Tudo</button>
      </div>
      <div class="varline"><div class="varpill" id="varpill-fx">—</div></div>
      <div id="chartFX" class="chart"></div>
      <div id="summaryFX" class="summary-grid fx"></div>
    </div>
  </div>
</section>

<script>
/* ---------- Data source ---------- */
const CSV_URL="data/indices_moveleiro.csv"; // confirmed path
let RAW=null;
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const isMobile = () => window.innerWidth < 720;

/* ---------- Parsing & normalization ---------- */
function toNumber(v){ if(v==null||v==="")return null; if(typeof v==="number")return v;
  const n=parseFloat(String(v).replace(",",".").trim()); return Number.isFinite(n)?n:null; }
function normalizeRow(r){ return {
  date:r.date, crc:toNumber(r.CRC_China_USD_ton), iron:toNumber(r.Iron_Ore_USD_ton),
  freight:toNumber(r.Sea_Freight_USD_ton), usdbrl:toNumber(r.USD_BRL_buy), usdcny:toNumber(r.USD_CNY)
};}

/* v4.9: Reduce Sea Freight to one entry per month (keeps latest date)
   v4.9.1: also used in Overview to align endpoints
   v4.9.2: unchanged logic, still authoritative series for Sea Freight */
function monthlyReduceFreight(dates, values){
  const map = new Map(); // key = YYYY-M, value = {date, value}
  for(let i=0;i<dates.length;i++){
    const d = new Date(dates[i]);
    const key = `${d.getFullYear()}-${d.getMonth()+1}`;
    map.set(key, {date: dates[i], value: values[i]}); // overwrite → latest wins
  }
  const reduced = Array.from(map.values());
  reduced.sort((a,b)=> new Date(a.date) - new Date(b.date));
  return {dates: reduced.map(v=>v.date), values: reduced.map(v=>v.value)};
}

function loadCSV(){
  return new Promise((res,rej)=>{
    Papa.parse(`${CSV_URL}?v=${Date.now()}`,{
      download:true, header:true, complete:(r)=>{
        const rows=r.data.filter(x=>x&&x.date);
        const n=rows.map(normalizeRow);
        const o={date:[],crc:[],iron:[],freight_raw:[],usdbrl:[],usdcny:[]};
        n.forEach(v=>{ o.date.push(v.date); o.crc.push(v.crc); o.iron.push(v.iron);
          o.freight_raw.push(v.freight); o.usdbrl.push(v.usdbrl); o.usdcny.push(v.usdcny); });

        /* v4.9.1/4.9.2: build reduced monthly freight arrays for plotting & metrics */
        const reduced = monthlyReduceFreight(o.date, o.freight_raw);
        o.freight_dates = reduced.dates; // monthly timestamps for freight
        o.freight = reduced.values;      // monthly values for freight

        res(o);
      }, error:rej
    });
  });
}

/* ---------- Ticks & slicing ---------- */
/* Month ticks: every other month with YEAR (ABR 24, JUN 24, ...) */
function evenMonthTicksWithYear(dates){
  const seen=new Set(), tickvals=[], ticktext=[];
  for(const iso of dates){
    const dt=new Date(iso); const m=dt.getMonth()+1; const y=String(dt.getFullYear()).slice(-2);
    const key = dt.getFullYear()+"-"+m;
    if(m%2===0 && !seen.has(key)){ seen.add(key); tickvals.push(iso); ticktext.push(PT_ABBR[dt.getMonth()]+" "+y); }
  }
  return {tickvals, ticktext};
}

/* Range slice in months */
function sliceByMonths(dates, arraysObj, months){
  if(months==null) return {dates:[...dates], ...Object.fromEntries(Object.keys(arraysObj).map(k=>[k,[...arraysObj[k]]]))};
  const last=new Date(dates[dates.length-1]);
  const from=new Date(last); from.setMonth(from.getMonth()-months);
  const ix=dates.findIndex(d=>new Date(d)>=from);
  const start = ix<0 ? 0 : ix;
  const outDates = dates.slice(start);
  const outObj = {};
  for(const k in arraysObj) outObj[k]= arraysObj[k].slice(start);
  return {dates:outDates, ...outObj};
}

/* Quarterly % changes (first vs last in each quarter) */
function quarterChanges(dates, vals){
  const yearly={};
  for(let i=0;i<dates.length;i++){
    const dt=new Date(dates[i]); const y=dt.getFullYear(); const q=Math.floor(dt.getMonth()/3)+1;
    yearly[y]=yearly[y]||{1:[],2:[],3:[],4:[]}; yearly[y][q].push(vals[i]);
  }
  const out={};
  for(const y in yearly){
    out[y]={};
    for(let q=1;q<=4;q++){
      const a=yearly[y][q]; if(!a.length){ out[y][q]=null; continue; }
      const f=a[0], l=a[a.length-1]; out[y][q]=(f!=null&&l!=null)?((l-f)/f*100):null;
    }
  }
  return out;
}

/* ---------- v4.9.2: Month-end helpers for accurate “Último mês” ---------- */
/* Collapses any series to the last entry per month */
function monthEndSeries(dates, values){
  const map = new Map();
  for(let i=0;i<dates.length;i++){
    const d = new Date(dates[i]);
    const key = `${d.getFullYear()}-${d.getMonth()+1}`;
    map.set(key, {date: dates[i], value: values[i]}); // last seen in month
  }
  const arr = Array.from(map.values()).sort((a,b)=> new Date(a.date) - new Date(b.date));
  return { dates: arr.map(x=>x.date), values: arr.map(x=>x.value) };
}
/* Formats “SET – OUT 2025” */
function formatMoMLabel(d1, d2){
  const m1 = PT_ABBR[d1.getMonth()];
  const m2 = PT_ABBR[d2.getMonth()];
  const y2 = d2.getFullYear();
  return `${m1} – ${m2} ${y2}`;
}

/* ---------- Analytics (variação, média, volatilidade) ---------- */
function metricsForSeries(dates, series, months){
  const sliced = sliceByMonths(dates, {y:series}, months);
  const y = sliced.y.filter(v=>v!=null);
  if(y.length<2) return {total:null, avg:null, vol:null};
  const first=y[0], last=y[y.length-1];
  const total = (last-first)/first*100;
  let sum=0, absSum=0, steps=0;
  for(let i=0;i<y.length-1;i++){
    if(y[i]==null||y[i+1]==null) continue;
    const r = (y[i+1]-y[i])/y[i]*100;
    sum+=r; absSum+=Math.abs(r); steps++;
  }
  const avg = steps? (sum/steps):null;
  const vol = steps? (absSum/steps):null;
  return {total, avg, vol};
}
const pct = v => v==null ? "—" : ((v>=0?"+":"")+v.toFixed(1).replace(".",",")+" %");

/* ---------- v4.9.2: “Último mês” (only for latest year) ---------- */
function lastMonthLine(dates, vals, yearFilter=null){
  const reduced = monthEndSeries(dates, vals); // last entry per month
  const arr = reduced.dates.map((d,i)=>({d,v:reduced.values[i]}));
  const filtered = yearFilter ? arr.filter(o=>new Date(o.d).getFullYear()===yearFilter) : arr;
  if(filtered.length<2) return "";
  const d1=new Date(filtered[filtered.length-2].d), d2=new Date(filtered[filtered.length-1].d);
  const v1=filtered[filtered.length-2].v, v2=filtered[filtered.length-1].v;
  const p=((v2-v1)/v1*100);
  return `Último mês (${formatMoMLabel(d1,d2)}): ${pct(p)}`;
}
function lastMonthLineFX(dates, vals, yearFilter=null){
  const reduced = monthEndSeries(dates, vals);
  const arr = reduced.dates.map((d,i)=>({d,v:reduced.values[i]}));
  const filtered = yearFilter ? arr.filter(o=>new Date(o.d).getFullYear()===yearFilter) : arr;
  if(filtered.length<2) return "";
  const d1=new Date(filtered[filtered.length-2].d), d2=new Date(filtered[filtered.length-1].d);
  const v1=filtered[filtered.length-2].v, v2=filtered[filtered.length-1].v;
  const p=((v2-v1)/v1*100);
  return `Último mês (${formatMoMLabel(d1,d2)}): ${pct(p)}`;
}

/* ---------- Render: summaries ---------- */
function renderSummary(containerId, qData, dates, vals){
  const el=document.getElementById(containerId); if(!el) return;
  const yrs=Object.keys(qData).map(Number).sort((a,b)=>b-a);
  const [y1,y2]=yrs.length>=2?[yrs[0],yrs[1]]:[yrs[0],yrs[0]];
  const latestYear = Math.max(...Object.keys(qData).map(Number));
  const fmt=v=>v==null?"n/d":pct(v);

  const block=y=>{
    const quarters = [1,2,3,4].map(q=>`<li>${q}º trimestre: ${fmt((qData[y]||{})[q])}</li>`).join("");
    const lastLine = (y===latestYear) ? `<div class='fx-last'>${lastMonthLine(dates, vals, y)}</div>` : "";
    return `<div class='year-block'><div class='year-title'>${y}</div><ul>${quarters}</ul>${lastLine}</div>`;
  };
  el.innerHTML = `<div class="summary-grid">${block(y1)}${block(y2)}</div>`;
}

/* 4-column FX (2025 BRL | 2025 CNY | 2024 BRL | 2024 CNY), “Último mês” only in latest year cols */
function renderSummaryFX(containerId, dates, usdbrl, usdcny){
  const el=document.getElementById(containerId); if(!el) return;
  const qb = quarterChanges(dates, usdbrl);
  const qc = quarterChanges(dates, usdcny);
  const years = Array.from(new Set(dates.map(d=>new Date(d).getFullYear()))).sort((a,b)=>b-a);
  const y1 = years[0], y2 = years[1] ?? years[0];
  const latestYear = y1;
  const fmt=v=>v==null?"n/d":pct(v);

  function col(year, label, series, qmap){
    const items = [1,2,3,4].map(q=>`<li>${q}º trimestre: ${fmt((qmap[year]||{})[q])}</li>`).join("");
    const lastLine = (year===latestYear) ? `<div class="fx-last">${lastMonthLineFX(dates, series, year)}</div>` : "";
    return `<div class="year-block">
      <div class="fx-cap">${year} ${label}</div>
      <ul>${items}</ul>
      ${lastLine}
    </div>`;
  }

  el.innerHTML = [
    col(y1, "USD/BRL", usdbrl, qb),
    col(y1, "USD/CNY", usdcny, qc),
    col(y2, "USD/BRL", usdbrl, qb),
    col(y2, "USD/CNY", usdcny, qc),
  ].join("");
}

/* ---------- Chart helpers ---------- */
const RANGES = {geral:"Tudo", crc:"Tudo", iron:"Tudo", freight:"Tudo", fx:"Tudo"};
const RANGE_TO_MONTHS = { "3M":3, "6M":6, "1A":12, "5A":60, "Tudo":null };

function lineCfg(color){
  return {
    mode:'lines+markers',
    line:{shape:'spline',smoothing:.6,width:isMobile()?2:3.2,color:color},
    marker:{size:isMobile()?5:7,line:{width:1,color:'#fff'}}
  };
}
function axisLayout(baseTitle, xticks){
  const tf = isMobile() ? 10 : 12;
  return {
    hovermode:'x unified',
    legend:{orientation:'h', y:-0.25, font:{size:isMobile()?11:12}},
    xaxis:{showgrid:false, tickmode:'array', ...xticks, tickfont:{size:tf}, automargin:true},
    yaxis:{gridcolor:'#e9ecef', zeroline:false, title:baseTitle, tickfont:{size:tf}, automargin:true},
    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    margin:{t:40,r:30,b:80,l:60}
  };
}

/* ---------- Drawers ---------- */
function drawGeral(){
  const m = RANGE_TO_MONTHS[RANGES.geral];

  /* v4.9.1: Overview uses reduced monthly Freight series to avoid early cutoff */
  const sliced = sliceByMonths(
    RAW.date,
    {crc: RAW.crc, iron: RAW.iron, usdbrl: RAW.usdbrl, usdcny: RAW.usdcny},
    m
  );
  const slicedFreight = sliceByMonths(RAW.freight_dates, {freight: RAW.freight}, m);

  const D = {
    date: sliced.dates,
    crc: sliced.crc,
    iron: sliced.iron,
    usdbrl: sliced.usdbrl,
    usdcny: sliced.usdcny,
    freight_dates: slicedFreight.dates,
    freight: slicedFreight.freight
  };

  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);

  if (RAW.date.length){
    const dt=new Date(RAW.date.at(-1));
    const txt=`Última atualização: ${dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'})}`;
    const lastHeader=document.getElementById('lastUpdateHeader');
    if (lastHeader) lastHeader.textContent = txt;
  }

  Plotly.newPlot('chartGeral',[
    {x:D.date, y:D.crc, name:'Aço CRC China (USD/TON)', ...lineCfg('#007bff')},
    {x:D.date, y:D.iron, name:'Minério de Ferro (USD/TON)', ...lineCfg('#ff6f00')},
    {x:D.freight_dates, y:D.freight, name:'Frete Marítimo (USD/TEU)', ...lineCfg('#00bfa6')},
    {x:D.date, y:D.usdbrl, name:'USD/BRL', yaxis:'y2', ...lineCfg('#7e57c2')},
    {x:D.date, y:D.usdcny, name:'USD/CNY', yaxis:'y2', ...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/TON (CRC, Minério, Frete)', {tickvals, ticktext}),
    yaxis2:{title:'Câmbio (USD/BRL, USD/CNY)', overlaying:'y', side:'right', tickfont:{size:isMobile()?10:12}, automargin:true}
  }, {responsive:true});
}

function drawCRC(){
  const months = RANGE_TO_MONTHS[RANGES.crc];
  const sliced = sliceByMonths(RAW.date, {crc:RAW.crc}, months);
  const D = {date:sliced.dates, y:sliced.crc};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartCRC',[
    {x:D.date,y:D.y,name:'Aço CRC China (USD/TON)',...lineCfg('#007bff')}
  ], axisLayout('USD/TON', {tickvals, ticktext}), {responsive:true});
  renderSummary('summaryCRC', quarterChanges(RAW.date, RAW.crc), RAW.date, RAW.crc);

  const m = metricsForSeries(RAW.date, RAW.crc, months);
  document.getElementById('varpill-crc').textContent =
    `Variação total: ${pct(m.total)} | Média mensal: ${pct(m.avg)} | Volatilidade: ${pct(m.vol)}`;
}

function drawIron(){
  const months = RANGE_TO_MONTHS[RANGES.iron];
  const sliced = sliceByMonths(RAW.date, {iron:RAW.iron}, months);
  const D = {date:sliced.dates, y:sliced.iron};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartIron',[
    {x:D.date,y:D.y,name:'Minério de Ferro (USD/TON)',...lineCfg('#ff6f00')}
  ], axisLayout('USD/TON', {tickvals, ticktext}), {responsive:true});
  renderSummary('summaryIron', quarterChanges(RAW.date, RAW.iron), RAW.date, RAW.iron);

  const m = metricsForSeries(RAW.date, RAW.iron, months);
  document.getElementById('varpill-iron').textContent =
    `Variação total: ${pct(m.total)} | Média mensal: ${pct(m.avg)} | Volatilidade: ${pct(m.vol)}`;
}

function drawFreight(){
  const months = RANGE_TO_MONTHS[RANGES.freight];

  /* v4.9.1/4.9.2: use monthly-reduced freight arrays everywhere (chart, summaries, metrics) */
  const sliced = sliceByMonths(RAW.freight_dates, {freight:RAW.freight}, months);
  const D = {date:sliced.dates, y:sliced.freight};

  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  Plotly.newPlot('chartFreight',[
    {x:D.date,y:D.y,name:'Frete Marítimo (USD/TEU)',...lineCfg('#00bfa6')}
  ], axisLayout('USD/TEU', {tickvals, ticktext}), {responsive:true});

  const qFreight = quarterChanges(RAW.freight_dates, RAW.freight);
  renderSummary('summaryFreight', qFreight, RAW.freight_dates, RAW.freight);

  const m = metricsForSeries(RAW.freight_dates, RAW.freight, months);
  document.getElementById('varpill-freight').textContent =
    `Variação total: ${pct(m.total)} | Média mensal: ${pct(m.avg)} | Volatilidade: ${pct(m.vol)}`;
}

function drawFX(){
  const months = RANGE_TO_MONTHS[RANGES.fx];
  const sliced = sliceByMonths(RAW.date, {usdbrl:RAW.usdbrl, usdcny:RAW.usdcny}, months);
  const D = {date:sliced.dates, usdbrl:sliced.usdbrl, usdcny:sliced.usdcny};
  const {tickvals,ticktext}=evenMonthTicksWithYear(D.date);
  const minB=Math.min(...D.usdbrl.filter(v=>v!=null)), maxB=Math.max(...D.usdbrl.filter(v=>v!=null));
  const minC=Math.min(...D.usdcny.filter(v=>v!=null)), maxC=Math.max(...D.usdcny.filter(v=>v!=null));
  Plotly.newPlot('chartFX',[
    {x:D.date,y:D.usdbrl,name:'USD/BRL',...lineCfg('#7e57c2')},
    {x:D.date,y:D.usdcny,name:'USD/CNY',yaxis:'y2',...lineCfg('#e53935')}
  ],{
    ...axisLayout('USD/BRL', {tickvals, ticktext}),
    yaxis:{...axisLayout('').yaxis, title:'USD/BRL', range:[minB*0.98, maxB*1.02]},
    yaxis2:{title:'USD/CNY', overlaying:'y', side:'right', range:[minC*0.98, maxC*1.02], tickfont:{size:isMobile()?10:12}, automargin:true}
  }, {responsive:true});

  renderSummaryFX('summaryFX', RAW.date, RAW.usdbrl, RAW.usdcny);

  const mb = metricsForSeries(RAW.date, RAW.usdbrl, months);
  const mc = metricsForSeries(RAW.date, RAW.usdcny, months);
  document.getElementById('varpill-fx').textContent =
    `USD/BRL ${pct(mb.total)} (média ${pct(mb.avg)}, vol. ${pct(mb.vol)}) | ` +
    `USD/CNY ${pct(mc.total)} (média ${pct(mc.avg)}, vol. ${pct(mc.vol)})`;
}

/* ---------- Accordion ---------- */
function setExpanded(cardWrap, caretEl, expand){
  if (expand){
    cardWrap.style.display = 'block';
    cardWrap.style.maxHeight = '1px';
    requestAnimationFrame(()=>{ cardWrap.style.maxHeight = cardWrap.scrollHeight + 'px'; });
    if (caretEl) caretEl.textContent = '▼';
  } else {
    cardWrap.style.maxHeight = '0';
    if (caretEl) caretEl.textContent = '▶';
    setTimeout(()=>{ if(cardWrap.style.maxHeight==='0px') cardWrap.style.display='none'; }, 160);
  }
}
function initAccordion(){
  document.querySelectorAll('.titlebar.collapsible').forEach(tb=>{
    tb.addEventListener('click', ()=>{
      const id = tb.getAttribute('data-target');
      const cardWrap = document.getElementById(id);
      const caret = tb.querySelector('.caret');
      const willOpen = (cardWrap.style.display==='none' || cardWrap.style.maxHeight==='0px' || !cardWrap.style.maxHeight);
      setExpanded(cardWrap, caret, willOpen);
      if (willOpen){
        if(id==='geral-card') drawGeral();
        if(id==='crc-card')   drawCRC();
        if(id==='iron-card')  drawIron();
        if(id==='freight-card') drawFreight();
        if(id==='fx-card')    drawFX();
        tb.scrollIntoView({behavior:'smooth', block:'start'});
      }
    });
  });

  setExpanded(document.getElementById('geral-card'), document.getElementById('caret-geral'), true);
  setExpanded(document.getElementById('crc-card'), document.getElementById('caret-crc'), false);
  setExpanded(document.getElementById('iron-card'), document.getElementById('caret-iron'), false);
  setExpanded(document.getElementById('freight-card'), document.getElementById('caret-freight'), false);
  setExpanded(document.getElementById('fx-card'), document.getElementById('caret-fx'), false);
}

/* ---------- Ranges ---------- */
function setRangeActive(rangeBarId, key){
  const bar=document.getElementById(rangeBarId);
  bar.querySelectorAll('.rbtn[data-range]').forEach(b=>b.classList.toggle('active', b.dataset.range===key));
}
function initRanges(){
  const map = [
    ['range-geral','geral',drawGeral],
    ['range-crc','crc',drawCRC],
    ['range-iron','iron',drawIron],
    ['range-freight','freight',drawFreight],
    ['range-fx','fx',drawFX],
  ];
  map.forEach(([rid, key, drawer])=>{
    const bar = document.getElementById(rid);
    bar.addEventListener('click', (e)=>{
      const btn = e.target.closest('.rbtn');
      if(!btn) return;
      const sel = btn.dataset.range;
      if(sel){ RANGES[key] = sel; setRangeActive(rid, sel); drawer(); }
    });
  });
}

/* ---------- Boot ---------- */
(async function(){
  RAW = await loadCSV();
  initAccordion();
  initRanges();

  setRangeActive('range-geral', RANGES.geral); drawGeral();
  setRangeActive('range-crc', RANGES.crc);
  setRangeActive('range-iron', RANGES.iron);
  setRangeActive('range-freight', RANGES.freight);
  setRangeActive('range-fx', RANGES.fx);
})();
</script>
</body>
</html>
